# 조회수 설계

-   조회수
-   조회수 어뷰징 방지 정책

    -   각 사용자는 게시글 1개 당 10분에 1번 조회수 집계
    -   10분동안 100번 조회하더라도, 1번만 집계된다.

-   조회수는 게시글이 조회된 횟수만 저장

    -   다른 데이터의 개수로 파생 x
    -   전제 조회수를 단일 레코드에 비정규화 상태로 바로 저장

## 게시글/댓글/좋아요 와의 비교

-   데이터 일관성

    -   게시글/댓글/좋아요 : 비교적 중요
        -   원본 데이터를 통해 개수가 파생되므로 이러한 불일치가 발생하면 안된다.
        -   불일치가 발생하면 사용자가 인지할 수 있다.
    -   조회수 : 비교적 덜 중요
        -   모든 조회 내역을 보여주진 않는다. 단순히 조회된 횟수만 보여주면 된다.
        -   드물게 불일치가 발생하더라도 사용자가 인지하기 어렵다.

-   쓰기 트래픽
    -   게시글/댓글/좋아요 수 : 비교적 적다.
        -   게시글 작성, 댓글 작성, 좋아요 클릭등 사용자의 직접적인 액션에 의해 쓰기
    -   조회수 : 비교적 많다.
        -   단순히 게시글 조회만 해도 쓰기작업

데이터의 일관성이 덜 중요하고 다른 데이터에 의해 파생되는 데이터가 아니므로 트랜잭션이나 안전한 저장소가 반드시 필요하진 않다. 그리고 트래픽이 많다. -> 레디스 고려

## Redis

-   Single Thread

    -   단일스레드 순차적 처리
    -   동시성 문제 해결 유리

-   데이터 백업 지원

    -   메모리는 휘발성 저장소지만, Redis에서 데이터를 안전한 디스크에 저장하는 방법도 제공(AOF, RDB)
    -   AOF(Append Only File)
        -   수행된 명령어를 로그파일에 기록, 데이터 복구를 위해 로그를 재실행
    -   RDB
        -   Snapshot
        -   저장된 데이터를 주기적으로 파일에 저장.

-   Redis Cluster

    -   확장성, 부하 분산, 고가용성을 위한 분산 시스템 구성 방법 제공
    -   레디스도 분산을 구성하기 위한 기능 제공
        -   여러개의 Redis서버가 클러스터를 이루면서 분산 시스템 이룬다.
    -   레디스를 수평적으로 확장할 수 있게 해주는 기능
    -   샤딩 제공
    -   서버 추가시 자동 데이터 분산
    -   데이터 복제 기능 제공

-   애플리게이션에서 Redis저장 데이터 mysql에 저장
    -   약간의 데이터 유실 허용 실시간 데이터 백업 x
    -   시간 단위 백업
        -   배치 또는 스케줄 시스템 구축 필요
        -   백업 전 장애시 유실될 수 있음
    -   개수 단위 백업 (이방식 사용 및 백업시점 집계데이터는 인기글 사용)
        -   조회 시점에 간단히 처리
        -   백업 전 장애시 유실될 수 있음
        -   개수 단위 안채워지면 유실될 수 있음

```Java
private static final String KEY_FORMAT = "view::article::%s::view_count";

KEY_FORMAT.formatted(articleId);
```
