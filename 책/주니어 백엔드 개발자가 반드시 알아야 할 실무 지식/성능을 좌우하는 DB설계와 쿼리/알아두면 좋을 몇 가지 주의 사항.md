# 알아두면 좋을 몇 가지 주의사항

## 쿼리 타임아웃
응답지연으로 인한 재시도는 서버 부하를 더욱 가중시킨다. 앞선 요청을 아직 처리 중인 상황에서 새로운 요청이 유입되기 때문이다. 이런 식으로 재시도가 반복되면 동시에 처리해야 하는 요청 수가 기하급수적으로 늘어나고 서버 부하는 폭증하게 된다.

이런 상황을 방지하는 방법 중 하나는 쿼리 실행 시간을 제한(타임아웃 설정)하는 것이다. 

사용자는 에러 화면을 보게 되지만 서버 입장에서는 해당 요청을 정상적으로 종료(처리)한다. 사용자가 재시도를 하더라도 이전 요청이 여전히 처리 중인 상태가 아니므로 동시 요청 수의 폭증을 막을 수 있다.

쿼리 타임아웃은 서비스와 기능의 특성에 따라 다르게 설정해야 한다. 블로그 글을 조회하는 기능은 타임아웃을 몇 초 이내로 짧게 설정해도 되지만, 상품 결제 기능은 보다 긴 타임아웃이 필요하다.

결제 처리 중 타임아웃으로 에러가 발생하면 후속처리와 데이터 정합성이 복잡해질 수 있기 때문이다.

## 상태 변경 기능은 복제 DB에서 조회하지 않기
주DB - 복제 DB 구조를 사용할 때 변경은 주 DB를 사용하고 조회는 복제 DB를 사용한다. 

그런데 이를 잘못 이해해 모든 SELECT 쿼리를 무조건 복제 DB에서 실행하는 경우가 있다. 이는 2가지 측면에서 문제를 일으킬 수 있다.

- 주 DB와 복제 DB는 순간적으로 데이터가 일치하지 않을 수 있다. 주 DB에서 변경된 데이터는 다음 두 단계를 거쳐 복제 DB에 반영된다.
    - 네트워크를 통해 복제 DB에 전달
    - 복제 DB는 자체 데이터에 변경 내용을 반영

이 과정에는 시간이 걸린다. 주 DB에서 복제 DB로의 데이터 복제에는 지연이 발생한다. 이 지연시간만큼 주 DB와 복제 DB는 일시적으로 서로 다른 값을 갖게 된다.

이경우 잘못된 데이터를 조회하게 되어 사용자의 요청을 제대로 처리할 수 없게 된다.

- 트랜잭션 문제가 발생할 수 있다. 주 DB와 복제 DB간 데이터 복제는 트랜잭션 커밋 시 점에 이뤄진다. 주 DB의 트랜잭션에서 범위 내에서 데이터를 변경하고, 복제 DB에서 변경 대상이 될 수 있는 데이터를 조회하면 데이터 불일치로 인해 문제가 생긴다.

DML 쿼리 실행후 변경대상 데이터를 조회해야 한다면 복제 DB가 아닌 DML 쿼리를 실행하는 주 DB에서 SELECT 쿼리를 실행해야 한다.

## 배치 쿼리 실행 시간 증가
집계 쿼리는 그 특성상 많은 양의 메모리를 사용하게 되며, 특정 임계점을 넘기면 실행 시간이 예측할 수 없을 만큼 길어질 수 있다.

이런 문제를 예방하려면 배치에서 사용하는 쿼리의 실행 시간을 지속적으로 추적해야 한다. 추적을 통해 쿼리 실행 시간이 갑자기 큰 폭으로 증가했는지를 감지할 수 있고, 문제가 되는 쿼리를 발견하면 원인을 찾아 해결할 수 있다.

가장 빠른 해결책은 DB장비의 사양을 높이는 것이다. 하지만 이 방법은 항상 가능한 것이 아니므로 다른 방법을 함께 고려해야 한다. 다음은 적용해 볼 수 있는 2가지 대안이다.
- 커버링 인덱스 활용
- 데이터를 일정 크기로 나눠 처리

## 타입이 다른 컬럼 조인 주의
비교하는 칼럼의 타입이 다르면 인덱스를 활용하지 못하는 문제가 있다. 이 문제를 해결하려면 두 칼럼의 타입을 맞춰서 비교해야 한다.

## 테이블 변경은 신중하게
데이터가 많은 테이블에 새로운 컬럼을 추가하거나 기존 열거 타입 컬럼을 변경할 때는 매우 주의해야 한다. 무심코 컬럼을 변경했다가 서비스가 장시간 중단되는 상황이 발생할 수 있다.

테이블 변경 시 주의해야 하는 이유는 DB의 테이블 변경 방식 때문이다. 테이블 변경중에는 보통 DML작업을 허용하지 않기 떄문에 함부로 변경했다가 재앙이 일어날 수 있다. (특히나 MySQL의 경우 테이블 변경시 새 테이블을 생성하고 원본 테이블의 데이터를 복사한 뒤 복사가 완료되면 새 테이블로 대체한다.)

## DB 최대 연결 개수
DB 서버 자원에는 여유가 있지만 API 서버에서 DB에 연결되지 않는다면 DB에 설정된 최대 연결 개수를 확인해야 한다.

단 주의할 점이 있다. DB 서버의 사용률이 70% 이상으로 높다면 연결 개수를 늘리면 안된다. 연결 수가 많아질수록 DB 부하는 증가하고 성능 저하가 발생할 수 있다.

이런 경우에는 먼저 캐시 서버 구성이나 쿼리 튜닝 같은 조치를 통해 DB 부하를 낮추고 필요할 때 연결 개수를 늘려야 한다.