# 외부 연동과 DB 연동

## 외부 연동과 트랜잭션 처리
DB연동과 외부 연동을 함께 실행할 때에는 오류 발생 시 DB트랜잭션을 어떻게 처리할지 알맞게 판단해야 한다. 다음은 흔히 발생할 수 있는 2가지 상황이다.
- 외부 연동에 실패했을 때 트랜잭션을 롤백
- 외부 연동은 성공했지만 DB연동에 실패해 트랜잭션을 롤백

### 외부 연동에 실패했을 때 트랜잭션을 롤백

외부 연동에 실패했을 때 트랜잭션을 롤백하면, 변경한 데이터가 DB에 반영되지 않는다. 단순한 방식이지만 롤백을 통해 DB데이터에 이상이 생기는 것을 방지할 수 있다.

하지만 읽기 타임아웃이 발생해 트랜잭션을 롤백할 때는, 외부 서비스가 실제로는 성공적으로 처리했을 가능성을 염두에 두어야 한다.

트랜잭션을 롤백했는데 외부 서비스가 실제로는 성공했을 경우 2가지 방법 중 하나를 검토해야 한다.

첫 번째는 일정 주기로 두 시스템의 데이터가 일치하는지 확인하고 보정하는 방법이다.

두 번째는 성공 확인 API를 호출하는 방식이다. 읽기 타임아웃이 발생한 경우, 일정 시간 후에 이전 호출이 실제로 성공했는지 확인하는 API를 호출한다. 이때 성공 응답이 오면 트랜잭션을 지속하고, 실패 응답이 오면 트랜잭션을 롤백한다. (이방식은 성공 여부를 알려주는 API를 제공할 때만 사용할 수 있다.)

이 방식의 변형으로 취소 API를 호출하는 방법도 있다 읽기 타임아웃이 발생한 뒤 일정 시간 후에 취소 API를 호출하는 것이다. 연동 서비스는 취소할 대상이 있으면 취소 처리를 수행한뒤 성공 응답을 주고, 취소할게 없다면 아무 동작 없이 성공 응답만 반환한다. (이경위에는 처리를 취소했으므로 트랜잭션을 롤백하면 된다.)

연동서비스에서 위 API를 지원해주더라도 이 API를 호출하는 과정에서도 읽기 타임아웃이 발생할 수 있다.

따라서 두 시스템 간 데이터 일관성이 중요한 기능이라면 정기적으로 데이터 일치를 확인하는 프로세스를 갖추는 것이 바람직하다.

### 외부 연동은 성공했는데 DB 연동에 실패해서 트랜잭션을 롤백
외부 연동은 성공했지만 DB 연동에 실패해 트랜잭션을 롤백한 경우에는 취소 API를 호출해 외부 연동을 이전 상태로 되돌리는 것이 필요하다. 

취소 API가 없거나 취소에 실패할 수도 있기 떄문에 데이터 일관성이 중요한 서비스라면 일정 주기도 데이터가 맞는지 비교하는 프로세스를 갖추는 것이 좋다.

## 외부 연동이 느려질 때 DB 커넥션 풀 문제
DB 트랜잭션 범위 안에서 외부 연동을 수행할 때, 외부 연동이 느려지면서 커넥션 풀 부족현상이 발생할 수 있다.

DB연동과 무관하게 외부 연동을 실행할 수 있다면 DB 커넥션을 사용하기 전이나 후에 외부 연동을 시도하는 방안도 고려해볼 수 있다.

이렇게 하면 외부 연동 시간이 길어지더라도 DB 커넥션 풀이 포화되는 상황을 방지할 수 있다.

단 이 방식은 외부 연동이 트랜잭션 범위 밖에서 실행되기 떄문에 트랜잭션 커밋 이후 외부 연동이 실패하면 롤백이 불가능하다는 점을 고려해야 한다.

이 경우에는 실패한 외부 연동에 대한 후처리를 반드시 고민해야 한다.

후처리 방법으로는 트랜잭션으로 반영된 데이터를 되돌리는 보상 트랜잭션을 사용하는 방법 또는 기능 특성에 따라 데이터를 후보정하는 방법 등이 있다.

