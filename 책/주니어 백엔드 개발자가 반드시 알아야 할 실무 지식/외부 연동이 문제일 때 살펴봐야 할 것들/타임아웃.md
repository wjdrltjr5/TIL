# 타임아웃
외부 연동에서 가장 중요한 설정 중 하나는 타임아웃이다. 연동 서비스를 호출할 때 타임아웃을 적절히 설정하지 않으면 연동 서비스에 장애가 발생했을 때 전체 서비스의 품질이 급격히 나빠질 수 있다.

사용자는 응답이 올때까지 기다리지 않는다. 새로 고침과 같은 방법으로 새로운 요청을 보낸다. 이는 문제를 더 악화시킨다. 사용자 입장에서는 앞서 보낸 요청을 취소한 것이지만 서비스는 그 사실을 알지 못하고 앞서 사용자가 보낸 요청을 여전히 처리 중이다.

이 상태에서 새로고침을 통해 새로운 요청이 하나 더 들어오게 된다. 즉 서버가 받는 부하가 배가되는 상황이 발생한다.

이런 문제를 완화할 수 있는 방법 중 하나는 연동에 대해 타임아웃을 지정하는 것이다. 사용자는 타임아웃으로 지정한 시간 뒤에 에러 화면을 보게된다.

반응없는 무한 대기 보다는 에러 화면이라도 보는 것이 더 낫다. 또한 서버는 사용자 요청에 대해 자원이 포화되기 전에 응답하므로 연동 서비스 문제가 다른 기능에 주는 영향을 줄일 수 있다.

## 2가지 타임아웃 : 연결 타임아웃, 읽기 타임아웃
API 연동에서 통신 과정을 단순화해 표현하면 연결, 요청, 응답, 종료 4단계를 거친다.

네트워크 연결에도 시간이 걸린다. 연결에 시간이 오래 걸리면 대기 시간도 함께 증가한다. 대기 시간이 무한정 길어지면 성능 문제가 발생하므로 연결 타임아웃을 설정해 연결 대기 시간을 제한해야 한다.

일단 연결이 되면 요청을 전송하고 응답을 기다리게 된다. 이때 응답을 받기까지 시간이 오래 걸리면 앞서 말한 대기 시간 문제가 다시 발생한다. 따라서 읽기 타임아웃을 설정해서 응답 대기 시간을 제한해야 한다.

처음 연동하는 서비스라면 타임아웃 시간을 아래와 같이 설정한 뒤 추이를 보면서 조정하는 것이 좋다.
- 연결 타임아웃 : 3초 ~ 5초
- 읽기 타임아웃 : 5초 ~ 30초

읽기 타임아웃이 다소 길게 느껴질 수 있지만 짧게 설정하면 타임아웃 에러가 자주 발생할 수 있다. 게다가 시간이 너무 짧으면 연동서비스가 정상 처리했음에도 불구하고 타임아웃 에러가 날 수 있다.

읽기 타임아웃을 지정할 때는 실제로 설정하는 값이 무엇인지 확인해야 한다. 
- Apache Http Client : 소켓 타임아웃 설정으로 소켓 타임아웃은 네트워크 패킷 단위를 기준으로 하므로 전체 응답 시간에 대한 타임아웃을 의미하지는 않는다. 따라서 전체 응답시간이 지정한 시간보다 더 걸릴 수 있다.

- OkHttp : 읽기 타임아웃과는 별개로 호출 타임아웃을 설정할 수 있다. 호출 타임아웃은 요청 시작부터 응답까지의 전체 시간 기준으로 설정된다.