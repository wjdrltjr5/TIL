# 네트워크 IO와 자원 효율
서버 프로그램은 기본적으로 네트워크 프로그램이다 다양한 구성요소와 네트워크를 통해 데이터를 주고받는다.

많은 서버는 HTTP 프로토콜을 이용해서 클라이언트와 데이터를 주고받는다. 데이터 처리르 위해 DB를 사용하는데 DB는 TCP에 기반한 프로토콜을 사용해서 데이터를 주고 받는다. 

레디스를 메모리 캐시로 사용할 때도 네트워크를 통해 데이터를 주고받는다 네트워크를 통해 데이터를 주고받는 과정은 간단하게 다음 두줄로 정리할 수 있다.

```java
outputStream.write(...); // 출력 스트림으로 내보내기
inputStream.read(...); // 입력 스트림으로 데이터 받기
```

데이터 입출력이 완료될 때까지 스레드는 아무 작업도 하지 않고 입출력이 끝나기를 기다린다. 즉 입출력이 끝날때까지 블로킹된다. 보통 입출력에 소요되는 시간은 코드를 실행하는 시간보다 훨씬 길다.

CPU 사용률을 높이려면 CPU가 실행할 스레드를 많이 만들면 된다. 요청당 스레드 방식으로 구현한 서버가 이에 해당한다. 동시에 실행되는 스레드 개수를 늘려 IO대기에 따른 CPU 낭비를 줄일 수 있다.

하지만 스레드를 생성하는 데는 한계가 있다(자원소모) 메모리를 늘려 스레드를 많이 만들 수 있게 되더라도 컨텍스트 스위칭 비용이 올라간다.

정리하면 트래픽이 증가하면 2가지 이유로 자원 효율이 떨어지게 된다.
- IO대기와 컨텍스트 스위칭에 따른 CPU 낭비
- 요청마다 스레드를 할당함으로써 메모리 사용량이 높음

톰캣이 요청마다 스레드 할당하는 이유는 다수의 서버는 자원의 낭비를 걱정할 필요가 없다 CPU와 메모리 사용에 영향을 줄만큼 트래픽이 발생하지 않기 때문

수백만 또는 수천만 이상의 고객이 사용할 정도로 인기 있는 서비스가 아니라면 CPU와 메모리 자원 부족보다는 다른 이유로 성능 문제가 발생할 때가 많다.

트래팩이 많이 증가한다면 이때부터 처리량을 더 높이기 위한 방법을 고민하면 된다.
- 서버를 확장하거나(비용 문제)
- 자원 효율을 높이거나
    - 가상 스레드나 고루틴 같은 경량 스레드 사용 
    - 논블로킹 또는 비동기 IO사용