# 파일 디스크립터 제한
프로세스는 데이터 입출력이 필요할 때 OS로부터 파일 디스크립터를 할당받는다. 

OS는 사용자나 시스템 수준에서 생성할 수 있는 파일 디스크립터 개수를 제한한다. 프로세스는 제한된 개수의 파일 디스크립터를 초과해서 생성할 수 없다. 예로 사용자의 파일 디스크립터 개수 제한이 1024 라면 프로세스는 파일과 소켓을 합쳐 1024개를 초과해서 열 수 없다.

동시에 그 이상을 클라이언트가 시도하면 Too Many Open Files 와 같은 오류 메시지와 함께 소켓 생성에 실패한다.

이런 오류를 방지하려면 트래픽 증가에 맞춰 미리 파일 디스크립터 개수 제한을 확인하고 늘려야 한다.  프로세스가 생성할 수 있는 파일 디스크립터 개수 제한은 여러 방법으로 확인할 수 있다.

먼저 ulimit -a 명령어로 사용자의 파일 디스크립터 개수 제한을 확인할 수 있다. 어래 결과에서 open files 값이 파일 디스크립터 개수 제한이다.
```shell
$ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 31671
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 31671
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

위 결과는 현재 터미널에 접속한 사용자가 생성한 프로세스의 파일 디스크립터 개수 제한이 1024라는 것을 알려준다.

사용자의 파일 디스크립터 제한을 변경하려면 `ulimit -n 개수`  명령어를 사용한다. 이 명령어는 현재 사용자 세션을  기준으로 파일 디스크립터 제한을 설정한다.

세션을 기준으로 적용되므로 다른 세션에는 적용되지 않으며, 로그아웃하고 다시 접속하면 기본 값이 적용된다.

사용자의 기본 파일 디스크립터 제한을 변경하고 싶다면 /etc/security/limits.conf 파일을 수정한다. 
예로 모든 사용자의 파일 디스크립터 제한을 10만으로 변경하려면 아래 설정을 추가한다.
```txt
* soft nofile 100000
* hard nofile 100000
```

맨 앞의 *은 모든 사용자에 적용한다는 뜻이다. nofile은 파일 디스크립터 개수를 의미한다. soft와 hard는 각각 사용자의 기본 값과 설정할 수 있는 최대 값을 지정한다. 프로세스는 soft로 지정한 값을 기본으로 사용하고 부족할 경우 hard로 지정한 값까지 사용할 수 있다. 단 사용자는 hard로 지정한 값 이상으로는 사용할 수 없다.

systemd로 실행하는 서비스의 파일 디스크립터 제한은 systemctl show 명령어로 확인할 수 있다.

```
$ systemctl show -p DefaultLimitNOFILE
DefaultLimitNOFILE = 524288
```

위 명령어는 systemd로 실행되는 서비스의 기본 파일 디스크립터 제한을 보여준다. systemd로 실행되는 서비스는 ulimit이나 limits.conf 파일에 설정한 값을 사용하지 않는다. systemd는 /etc/systemd/system.conf 파일에 있는 DefaultLimitNOFILE 값을 서비스의 기본 파일 디스크립터 제한 값으로 사용한다.

system.conf파일을 수정하면 systemctl daemon-reload 명령어로 설정을 반영한다.

각 서비스마다 다른 값을 지정할 수도 있다. 개별 서비스 설정 파일에 다름과 같이 LimitNOFILE 설정을 추가하면된다. (개별 서비스 파일은 /etc/systemd/system 디렉토리나 /usr/lib/systemd/system 디렉토리에 위치)

한 프로세스가 가질 수 있는 파일 디스크립터 개수 제한도 확인해야 한다. 이값은 다음 명령어로 확인할 수 있다.
> $ sysctl fs.nr_open

일반적으로 이 값은 충분히 큰 값을 가지므로 변경할 필요가 없지만, 더 큰 값이 필요하다면 /etc/sysctl.conf파일에 fs.nr_open 설정을 변경한다.

시스템 전체의 파일 디스크립터 개수를 제한할 수도 있다. 다음 명령어를 사용해서 시스템 수준의 제한을 확인할 수 있다.
> sysctl fs.file-max

충분히 크다면 늘릴 필요가 없지만 값이 작아서 변경하고 싶다면 /etc/sysctl.conf파일에 fs.file-max 설정을 변경하면 된다.

sysctl.conf 파일을 수정한 뒤에는 sysctl -p 명령어로 적용한다.

프로세스의 파일 디스크립터 제한 값은 다음 명령어를 사용해서 확인할 수 있다.
> cat /proc/프로세스ID/limits

> prlimit --pid 프로세스ID

실제 프로세스가 사용중인 파일 디스크립터 개수를 확인하고 싶다면 lsof 명령어를 사용한다.
> lsof -p 프로세스 ID

> lsof -p 프로세스 ID | wc -l