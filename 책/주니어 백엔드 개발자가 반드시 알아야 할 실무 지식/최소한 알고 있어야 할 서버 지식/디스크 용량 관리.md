# 디스크 용량 관리
디스크가 가득 차서 발생하는 문제를 방지하려면, 서버 모니터링 도구가 디슼트 사용률에 따른 알림 기능을 제공해야 한다. 보통은 경고와 위험을 나타내는 2개의 사용률을 설정한다.

디스크 사용률이 높다는 알림을 받으면 즉시 파일 삭제 같은 조치를 취해야 한다. 리눅스에서는 df명령어를 사용해서 어떤 파티션의 사용률이 높은지 확인할 수 있다.

-h 옵션을 붙여서 사용하면 용량이 바이트 단위가 아닌 MB(M) 이나 GB(G) 단위로 표시되어 쉽게 확인할 수 있다.

```shell
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G     0  3.9G   0% /dev
tmpfs           797M  1.8M  795M   1% /run
/dev/sda1        40G  7.4G   31G  20% /
tmpfs           3.9G     0  3.9G   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup
/dev/sdb1       200G  120G   70G  64% /home
/dev/sdc1       500G  100G  400G  20% /data
/dev/loop0       24M   24M     0 100% /snap/firefox/1234
/dev/loop1       99M   99M     0 100% /snap/core/12345
```

삭제 대상을 찾을 때는 어떤 디렉토리가 많은 용량을 차지하는지 확인해야 한다. 이럴 떄 du 명령어를 사용한다. du는 disk usage의 약자로, 하위 디렉토리나 파일이 차지하는 용량을 쉽게 확인할 수 있다.

```shell
$ du -sh ./*
4.0K    ./.bashrc
8.0K    ./.profile
96M     ./Downloads
4.0K    ./.cache
1.2G    ./Videos
44K     ./Documents
12M     ./Pictures
4.0K    ./.vimrc
```

-s 옵션을 사용하면 하뒤 디렉토리의 용량 합과 파일의 크기를 보여준다. -h 옵션은 바이트 대신 사람이 읽기쉬운 k,m,g 단위로 용량을 표시해준다.

위 명령어를 사용하면 현재 디렉토리에 있는 모든 디렉토리와 파일의 용량을 표시한다. 파일을 제외한 하위 디렉토리의 용량 합만 구하고 싶다면 다음 du명령어를 사용한다,.
> $ du -sh */

일반적으로 서버 프로그램에서 디스크 용량과 관련된 파일은 다음 2가지다.
- 로그파일
- 파일저장(임시 파일등)

로그파일을 정리하는 가장 쉬운 방법은 오래된 로그를 삭제하는 것 필요하다면 별도 저장소로 로그를 백업한다. 로그파일을 압축해서 추가 공간을 확보할 수도 있다. 로그와 텍스트 파일은 압축 효율이 높으므로 일정 기간이 지난 로그파일을 압축해서 보관하면 로그가 사용하는 디스크 용량을 상당히 줄일 수 있다.

파일 저장 기능도 디스크 용량을 증가시킨다. 클라이언트가 전송한 파일을 로컬에 임시로 보관한 뒤에 파일 서버로 업로드하는 기능은 로컬 디스크에 임시로 생성한 파일을 남긴다. 이렇게 임시로 쌓이는 파일도 일정 시간이 지나면 삭제해서 디스크 용량이 불필요하게 증가하는 것을 방지해야 한다.

### find 명령어로 오래된 파일 삭제하기
find 리눅스 명령어를 사용하면 일정 기간이 지난 파일을 손쉽게 찾아서 삭제할 수 있다. 예로 logs 디렉토리에서 30일 이전 파일을 삭제하고 싶다면 아래 코드처럼 사용하면 된다.
> $ find ./logs -mtime +29 -type f -delete

한 디렉토리에 저장되는 파일 개수에도 주의해야 한다. 한 디렉토리에 저장되는 파일 개수가 증가하면 어느 시점부터 해당 디렉토리에 대한 파일 탐색 속도가 급격히 느려진다.

이런 문제가 발생하지 않으려면 한 디렉토리에 저장하는 파일 개수를 일정 개수 이하로 제한해야 한다.

흔히 사용하는 방법은 일자나 시간 기준으로 폴더를 생성하는 것

```
일반적으로 로그 파일은 일정 단위로 잘라서 보관한다. 로그 파일 개수를 고정해서 차례대로 파일을 바꿔가며 남기는 방식을 사용하기도 한다. 이렇게 로그 파일을 지정한 규칙에 따라 교대하는 것을 로그 로테이션이라고 한다.
```
