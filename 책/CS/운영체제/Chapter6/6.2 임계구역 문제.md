# 임계구역 문제

프로세스 동기화에 관한 논의는 소위 임계구역 문제라고 불리는 문제로부터 시작한다.

각 프로세는 `임계 구역`이라고 부르는 코드 부분을 포함하고 있고, 그안에서는 적어도 하나 이상의 다른 프로세스와 공유하는 데이터에 접근하고 갱신할 수 있다.

이 시스템의 중요한 특징은 한 프로세스가 자신의 임계구역에서 수행하는 동안 다른 프로세스들은 그 임계구역에 들어갈 수 없다는 사실

즉 동시에 두 프로세스는 그들의 임계구역안에서 실행할 수 없다. 임계구역 문제는 프로세스들이 데이터를 협력적으로 공유하기 위하여 자신들의 활동을 동기화할 때 사용할 수 있는 프로토콜을 설계하는 것

각 프로세스는 자신의 임계구역으로 진입하려면 진입 허가를 요청해야 한다. 이러한 요청을 구현하는 코드 부분을 `진입 구역`이라고 부른다.

임계구역 뒤에는 `퇴출 구역`이 따라올 수 있다. 코드의 나머지 부분들은 총칭하여 `나머지 구역`이라고 부른다.

`임계구역 문제에 대한 해결안은 다음의 세 가지 요구 조건을 충족해야 한다.`

-   `상호 배제(mutual exclusion)` : 프로세스 P가 자기의 임계구역에서 실행된다면 다른 프로세스들은 그들 자신의 임계구역에서 실행될 수 없다.

-   `진행 (progress)` : 자기의 임계구역에서 실행되는 프로세스가 없고 그들 자신의 임계구역으로 진입하려고 하는 프로세스들이 있다면, 나머지 구역에서 실행 중이지 않은 프로세스들만 다음에 누가 그 임계구역으로 진입할 수 있는지를 결정하는 데 참여할 수 있으며, 이 선택은 무한정 연기될 수 없다.

-   `한정된 대기(bounded waiting)` : 프로세스가 자기의 임계구역에 진입하려는 요청을 한 후부터 그 요청이 허용될 때까지 다른 프로세스들이 그들 자신의 임계구역에 진입하도록 허용되는 횟수에 한계가 있어야 한다.

우리는 각 프로세스가 0이 아닌 속도로 실행되는 것을 가정한다. 그러나 n개의 프로세스간의 상대적인 속도에 대한 가정은 하지 않는다.

임의의 한순간에 많은 커널 모드 프로세스들이 운영체제 안에서 활성화될 수 있다. 그 결과 운영체제를 구현하는 코드(커널 코드)는 경쟁 조건이 발생하기 쉽다.

-   파일의 리스트를 유지하는 커널 자료구조
-   메모리 할당을 관리하는 자료구조
-   프로세스 리스트를 유지하는 자료구조
-   인러텁트 처리를 위한 자료구조 등

운영체제에서 이러한 경쟁 조건이 발생하지 않도록 보장하는 것은 커넛 개발자의 책임

단일 코어 환경에서는 공유 변수를 수정하는 동안 인터럽트가 발생하는 것을 막을 수 있다면 임계구역 문제는 간단히 해결할 수 있다.

이렇게 하면 현재 실행 중인 명령어들을 선점없이 순서대로 실행될 수 있다는 것을 확신할 수 있다. 다른 명령어는 실행되지 않으므로 공유 변수를 예기치 않게 수정되지 않는다.

다중 처리기에서는 해당이 되지 않는다. 메시지가 모든 프로세서에 전달되므로 인터럽트를 비활성화 하면 시간이 많이 걸릴 수 있다.
이 메시지 전달은 각 임계구역으로의 진입을 지연시키고 시스템 효율성을 떨어트린다.

운영체제 내에서 임계구역을 다루기 위해서 `선점형 커널`과 `비선점형 커널`의 두가지 일반적인 접근법이 사용된다.

선점형 커널은 프로세스가 커널 모드에서 수행되는 동안 선점되는 것을 허용한다.

비선점형 커널은 프로세스가 커널모드에 수행되는 프로세스의 선점을 허용하지 않고 커널 모드 프로세스는 커널을 빠져나갈 때 까지 또는 봉쇄될 떄까지 또는 자발적으로 CPU의 제어를 양보할 때까지 계속 수행된다

분명히 비선점형 커널은 한순간에 커널 안에서 실행 중인 프로세스는 하나밖에 없으므로 자료구조에 대한 경쟁 조건을 염려할 필요는 없다.

선점형 커널에 대해서는 동일한 주장을 할 수 없기 때문에 공유되는 커널 자료구조에서 경쟁 조건이 발생하지 않는다는 것을 보장하도록 신중히 설계되어야 한다.

SMP 구조에서 선점형 커널을 설게하는 것은 특히 어렵다. 이 환경에서는 서로 다른 처리기의 두 프로세스가 동시에 커널 모드에 있을 수 있기 떄문이다.
