# 다중 처리기(멀티 프로세서) 스케줄링

만일 여러개의 CPU가 사용 가능하다면, 여러 스레드가 병렬로 실행될 수 있으므로 `부하 공유`가 가능해진다. 그러나

그러나 스케줄링 문제는 그에 상응하여 더욱 복잡해진다 여기서도 최상의 해결책은 없다.

전통적으로 `다중 처리기`라는 용어는 여러 개의 물리적 프로세서를 제공하는 시스템을 말하며, 각 프로세서에는 하나의 단일 코어 CPU가 포함되어 있다.

최신 컴퓨팅 시스템에서는 이제 다중 처리기는 다음 시스템 아키텍처들에 사용할 수 있다.

-   다중 코어 CPU
-   다중 스레드 코어
-   NUMA 시스템
-   이기중 다중 처리

## 5.5.1 다중 처리기 스케줄링에 대한 접근 방법

다중 처리기 시스템의 CPU 스케줄링에 관한 한 가지 해결 방법은 마스터 서버라는 하나의 처리기가 모든 스케줄링 결정과 I/O 처리 그리고 다른 시스템의 활동을 취급하게 하는 것

다른 처리기들은 다만 사용자 코드만을 수행한다. 이러한 `비대칭 다중 처리(asymmetric multi processing)AMP`는 오직 하나의 코어만 시스템 자료구조에 접근하여 자료 공유의 필요성을 배제하기 때문에 간단하다.

위 접근방식의 단점은 마스터 서버가 전체 시스템 성능을 저하시킬 수 있는 병목이 된다는 것이다.

다중 처리기를 지원하기 위한 표준 접근 방식은 `대칭 다중 처리(symmetric multi processing)SMP` 이며 각 프로세서는 스스로 스케줄링 할 수 있다.

각 프로세서의 스케줄러가 준비 큐를 검사하고 실행할 스레드를 선택하여 스케줄링이 진행된다.

이는 스케줄 대상이 되는 스레드를 관리하기 위한 두 가지 가능한 전략을 제공한다.

-   모든 스레드가 공통 준비 큐에 있을 수 있다.

    -   공유 준비 큐에 경쟁 조건이 생길 수 있으므로 두 개의 다른 프로세서가 동일한 스레드를 스케줄 하지 않도록 그리고 큐에서 스레드가 없어지지 않도록 보장해야 한다.
    -   이 경쟁 조건으로부터 공통 준비 큐를 보호하기 위한 락킹 기법의 하나를 사용할 수 있다.
    -   큐에 대한 모든 액세스에 락 소유권이 필요하므로 성능의 병목이 될 수 있다.

-   각 프로세서는 자신만의 스레드 큐를 가질 수 있다.
    -   각 프로세서가 자신만의 실행 큐에서 스레드를 스케줄 할 수 있도록 허용하므로 공유 실행 큐와 관련되어 발생할 수 있는 성능 문제를 겪지 않는다.
    -   따라서 SMP를 지원하는 시스템에서 가장 일반적인 접근 방식
    -   자신만의 프로세서별 큐가 있으면 캐시 메모리를 보다 효율적으로 사용할 수 있다.

## 5.5.2 다중 코어 프로세서

SMP 시스템은 다수의 물리 처리기를 제공함으로써 다수의 프로세스가 병렬로 실행되게 한다.

현대 컴퓨터 하드웨어는 동일한 물리적인 칩 안에 여러 개의 처리 코어를 장착하여 `다중 코어 프로세서`가 된다.

`각 코어는 구조적인 상태를 유지하고 있어서 운영체제 입장에서는 개별적인 논리적 CPU로 보이게 된다.`

다중 코어 프로세서를 사용하는 SMP 시스템은 각 CPU가 자신의 물리 칩을 가지는 시스템과 비교해 속도가 빠르고 적은 전력을 소모한다.

다중 코어 프로세서는 스케줄링 문제를 복잡하게 한다. 연구자들은 프로세서가 메모리에 접근할 때 데이터가 가용해지기를 기다리면서 많은 시간을 허비한다는 것을 발견하였다

`메모리 스톨`이라고 하는 이 상황은 최신 프로세서가 메모리보다 훨씬 빠른 속도로 작동하기 때문에 주로 발생한다.

그러나 캐시 미스로 인해 메모리 스톨이 발생할 수도 있다. 이러한 상황을 해결하기 위해 최근의 많은 하드웨어 설계는 다중 스레드 처리 코어를 구현하였다.

이러한 설계에서 하나의 코어에 2개 이상의 `하드웨어 스레드`가 할당된다. 이렇게 하면 메모리를 기다리는 동안 하나의 하드웨어 스레드가 중단되면 코어가 다른 스레드로 전환할 수 있다.

운영체제 관점에서 각 하드웨어 스레드는 명령어 포인터 및 레지스터 집합과 같은 구조적 상태를 유지하므로 소프트웨어 스레드를 실행할 수 있는 논리적 CPU 로 보인다. `칩 다중 스레딩`

Intel 프로세서는 단일 하드웨어 코어에 여러 하드웨어 스레드를 할당하는 것을 설명하기 위하여 `하이퍼-스레딩[동시 다중 스레딩 또는 SMT]`라는 용어를 사용한다.

일반적으로 처리기를 다중 스레드화 하는 데에는 `거친`다중 스레딩과 `세밀한` 다중 스레딩의 2 가지 방법이 있다.

-   거친 다중 스레딩

    -   스레드가 메모리 스톨과 같은 긴 지연시간을 가진 이벤트가 발생할 때까지 한 코어에서 수행된다.
    -   긴 지연시간을 가진 이벤트에 의한 지연때문에 코어는 다른 스레드를 실행하게 된다.
    -   그 프로세서 코어에서 다른 스레드가 수행되기 전에 명령어 파이프라인이 완전히 정리되어야 하므로 스레드간 교환은 비용이 많이 든다.
    -   새로운 스레드가 실행을 시작하게 되면 자신의 명령어들로 파이프라인을 채우기 시작한다.

-   세밀한 다중 스레딩
    -   보통 명령어 주기의 경계에서 같이 좀 더 세밀한 정밀도를 가진 시점에서 스레드 교환이 일어난다.
    -   세밀한 시스템의 구조적 설게는 스레드 교환을 위한 회로를 포함한다. 그 결과 스레드 간 교환의 비용이 적어진다.

물리적 코어(캐시 및 파이프라인 등)의 자원은 하드웨어 스레드 간에 공유되어야 하므로 처리 코어는 한 번에 하나의 하드웨어 스레드만 실행할 수 있다는 것

결과적으로 다중 스레드 다중 코어 프로세ㅐ서는 현실적으로 두개의 다른 스케줄링 단계가 필요하다.

첫 번째 단게에는 운영체제가 각 하드웨어 스레드(논리적 CPU)에서 실행할 소프트웨어 스레드를 선택할 때 결정해야 하는 스케줄링 결정을 한다.

두 번째 단계는 각 코어가 실행할 하드웨어 스레드를 결정하는 방법을 명시한다.

이 상황에서 채택할 수 있는 몇 가지 전략이 있다. 한 가지 방법은 간단한 라운드 로빈 알고리즘을 사용하여 처리 코어에 하드웨어 스레드를 스케줄 하는 것 이것이 UltraSPARC T3에 의해 채택된 접근법이다.

다른 방법은 코어당 2개의 하드웨어-관리 스레드를 가진 이중 코어 프로세서인 Intel Itanium에서 사용된다.

각 하드웨어 스레드에는 0에서 7까지의 동적 긴급도가 배정되며 0은 가장 낮은 긴급도를 7은 가장 높은 긴급도를 나타낸다.

## 5.5.3 부하 균등화

SMP(하이퍼 스레딩, 동시 다중 스레딩)시스템에서 처리기가 하나 이상이라는 것을 최대한 활용하려면 부하를 모든 처리기에 균등하게 배분하는 것이 매우 중요하다.

그렇지 않으면 다른 처리기들이 큰 부하를 가지고 있으면서 준비 큐에 처리기를 기다리는 스레드들이 많은 상황에서 하나 이상의 처리기가 쉬게 된다.

`부하 균등화(load balancing)`는 SMP 시스템의 모든 처리기 사이에 부하가 고르게 배분되도록 시도한다.

`통상 각 처리기가 실행할 스레드를 위한 자기 자신만의 준비 큐를 가지고 있는 시스템에서만 필요한 기능이라는 것을 주의`

공통의 실행 큐만 있는 곳에서 한 처리기가 쉬게 되면 곧바로 공통 큐에서 새로운 프로세스를 선택하여 실행하기 때문에 부하 균등화는 필요 하지 않다.

부하 균등화를 위해서 push이주 와 pull 이주 방식의 두 가지 일반적인 접근법 이 있다.

-   push 이주 : 특정 태스크가 주기적으로 각 처리기의 부하를 검사하고 만일 불균형 상태로 밝혀지면 과부하인 처리기에서 쉬고 있거너 덜 바쁜 처리기로 스레드를 이동(push) 시킨다.

-   pull 이주 : 쉬고 있는 처리기가 바쁜 처리기를 기다리고 있는 프로세스를 pull할 때 일어난다.

push와 pull은 상호 배타적일 필요는 없으며 종종 병렬 적으로 구현된다.

균등 부하의 개념은 다른 의미를 가질 수 있다. 모든 큐에 같은 수의 스레드가 있어야 한다는 것 다른 관점으로는 균등이란 모든 큐에 스레드 우선순위를 균등하게 분배해야 한다는 것을 의미한다. 이러한 전략들을 스케줄링 알고리즘의 목표와 상충할 수 있다.

## 5.5.2 처리기 선호도

스레드에 의해 가장 최근에 접근된 데이터가 그 처리기의 캐시를 채우게 된다. 그결과 스레드에 의한 잇따른 메모리 접근은 캐시 메모리에서 만족한다.

스레드가 다른 처리기로 이주한다면 벌어지는일을 고려해야 한다.(부하 균등화로 인한 분산등)

첫 번째 프로세서의 캐시 메모리의 내용은 무효화 되어야 하며 두 번째 프로세서의 캐시는 다시 채워져야 한다.

캐시 무효화 및 다시 채우는 비용이 많이 들기 때문에 SMP를 지원하는 대부분의 운영체제는 스레드를 한 프로세서에서 다른 프로세서로 이주 시키지 않고 대신 같은 프로세서에서 계속 실행시키면서 warm cache를 이용하려고 한다.

이를 `프로세서 선호도`라고 한다. 프로세스는 현재 실행 중인 프로세서에 대한 선호도를 보인다.

스케줄링 가능한 스레드의 큐를 구성하기 위해 두 가지 전략(공통 큐, 각자 큐)은 프로세서 선호도에 영향을 미친다.

공통 준비 큐 접근 방식을 채택하면 선택된 스레드는 어느 처리기에서건 실행될 수 있다. 따라서 스레드가 새 프로세서에 스케줄 되면 해당 프로세서의 캐시를 다시 채워야 한다.

프로세서마다 자신만의 큐를 사용하면 스레드는 항상 동일한 프로세서에 스케줄 되므로 warm cache 내용을 활용할 수 있다.

기본적으로 프로세서별 준비 큐는 프로세서 선호도를 무료로 제공한다.

처리기 선호도는 여러 형태를 띤다. 운영체제가 동일한 처리기에서 프로세스를 실행시키려고 노력하는 정책을 가지고 있지만 보장하지는 않을 때 `약산 선호도(soft affinity)`를 가진다고 한다.

이 경우에 운영체제는 프로세스를 특정 처리기에서 실행하려고 노력은 하지만 프로세스가 처리기 사이를 이주하는 것이 가능하다.

대조적으로 Linux와 같은 몇몇 시스템은 `강한 선호도 (hard affinity)`를 지원하는 시스템 콜을 제공하는 데 이 시스템 콜을 통하여 프로세스는 자신이 실행될 처리기 집합을 명시할 수 있다.

많은 시스템은 약산 선호도와 강한 선호도를 모두 지원한다.

시스템의 메인 메모리 아키텍처는 프로세서 선호도 문제에도 영향을 줄 수 있다.

각각 고유한 CPU와 로컬 메모리를 가진 두개의 물리적 프로세서 칩이 있는 NUMA(non-uniform memory access)를 특징으로 하는 아키첵처는 시스템 연결망을 통해 NUMA시스템의 모든 CPU가 하나의 물리적 주소 공간을 공유할 수 있지만 CPU는 다른 CPU의 로컬 메모리보다 자신의 로컬 메모리에 더 빠르게 액세스할 수 있다.

운영체제의 CPU 스케줄러 및 메모리 배치 알고리즘이 NUMA를 인식하고 협력하는 경우 특정 CPU에 스케줄 된 스레드를 CPU가 있는 위치에 가장 가까운 메모리에 할당하여 가능한 가장 빠른 메모리 액세스를 제공할 수 있다.

부하 균등은 종종 프로세서 선호도의 이점을 상쇄한다. 즉 동일한 프로세서에서 스레드를 계쏙 실행하면 스레드가 해당 프로세서의 캐시 메모리에 있는 데이터를 활용할 수 있다는 이점이 있다.

스레드를 한 프로세서에서 다른 프로세서로 이동하여 부하를 균등하게 조정하면 이러한 이점이 사라진다.

즉 부하 균등하와 메모리 액세스 시간 최소화 사이에는 당연한 갈등이 생긴다.

## 5.5.5 이기종 다중 처리

모바일 시스템에서는 현재 다중 코어 아키텍처가 채택되어 있지만 일부 시스템은 동일한 명령어 집합을 실행하지만 전력 소비를 유휴 수준으로 조정하는 긴으을 포함하여 클록 속도 및 전력 관리 측면에서 차이가 나는 코어를 사용하여 설계되었다.

이러한 시스템을 `이기종 다중 처리(heterogeneous multiprocessing, HMP)`라고 한다.

시스템 및 사용자 태스크는 모든 코어에서 실행될 수 있으므로 비대칭 다중 처리 형태는 아니라는 사실에 주의

오히려 HMP의 목적은 작업의 특정 요구에 따라 특정 코어에 작업을 할당하여 전력 소비를 더 잘 관리하는 것

이를 지원하는 ARM 프로세서의 경우 이 유형의 아키텍처를 big.LITTLE이라고 하며 고성능 big 코어가 에너지 효율적인 LITTLE 코어와 결합한다.

Big 코어는 더 많은 에너지를 소모하므로 짧은 시간 동안만 사용해야 한다. 마찬가지로 little 코어는 더 적은 에너지를 사용하므로 더 오랫동안 사용할 수 있다.

이 방법의 몇가지 장점은 CPU 스케줄러는 느린코어를 더 빠른코어와 결합하여 고성능을 요구하지는 않지만 백그라운드 작업과 같은 더 긴 시간동안 실행해야 하는 작업을 little 코어에 할당하여 배터리 충전을 보존하는 데 도움을 준다.

마찬가지로 더 많은 처리능력이 필요하지만 짧은 기간동안 실행될 수 있는 대화형 응용 프로그램을 big 코어에 할당할 수 있다.

또한 모바일 장치가 절전 모드인 경우 big 코어를 비활성화할 수 있으며 시스템은 에너지 효율적인 little 코어에만 의존할 수 있다.

windows 10은 스레드가 전원 관리 요구를 가장 잘 지원하는 스케줄링 정책을 선택할 수 있게 하여 HMP 스케줄링을 지원한다.
