# 운영체제 빌딩과 부팅

하나의 특정 기기 구성에 맞게 운영체제를 설계, 코딩 및 구현할 수 있다. 그러나 보다 일반적으로 운영체제는 다양한 주변장치 구성을 가진 모든 종류의 컴퓨터에서 실행되도록 설계된다.

```
Linux를 위한  Window 서브시스템
Windows는 다른 운영체제 환경을 에물레이크 하기 위해 서브시스템을 제공하는 하이브리드 구조를 사용한다.

이러한 사용자 모드 서브시스템은 실제 서비스를 제공하기 위해 Windows커널과 통신한다.

Window에는 Linux용 Windows서브시스넴 (WSL)이 추가되어 네이티브 Linux응용 프로그램(ELF)을 Window에서 실행할 수 있다.

통상 사용자가 Windows 응용프로그램 bash.exe를 시작하고 Linux를 실행하는 bash셸을 사용자에게 제시한다.

내부적으로 WSL은 init 프로세스로 구성된 `Linux 인스턴스`를 섕성하고 네이티브 Linux응용프로그램 /bin/bash를 실행한는 bash 셸 프로세스를 생성한다.

이러한 각 프로세스는 Windows Pico 프로세스에서 실행된다. 이 특별한 프로세스는 네이티브 Linux 바이너리를 프로세스의 자체 주소 공간에 적재하여 Linux 응용 프로그램을 실행할 수 있는 환경을 제공한다.

Pico 프로세스는 커널 서비스 LXCore 및 LXSS와 통신하여 가능한 한 Linux 시스템 콜을 네이티브 Windows 시스템 콜로 변환한다.

만약 Linux응용프로그램이 상응하는 Windows 시스템 콜이 없는 요청을 한다면 LXSS는 일부 기능을 제공하고 나머지 기능을 제공하기 위해 유사한 Windows시스템 콜을 호출한다.
```

## 2.9.1 운영체제 생성

운영체제를 처음부터 생성(또는 빌딩)하는 경우 다음 절차를 밟아야 한다.

-   운영체제 소스 코드를 작성한다(또는 작성된 소스코드를 확보한다.)
-   운영체제가 실행될 시스템의 운영체제를 구성한다.
-   운영체제를 컴파일한다.
-   운영체제를 설치한다.
-   컴퓨터와 새 운영체제를 부팅한다.

일반적으로는 시스템 구성 방법을 설명하는 매개변수는 특정 유형의 구성 파일에 저장되며 이 파일을 만든 후에는 여러 가지 방법으로 사용할 수 있다.

시스템을 구성하려면 어떤 기능이 포함되는지 명시해야 하며 이는 운영체제에 따라 다르다.

시스템 관리자가 이를 사용하여 운영체제 소스 코드 사본을 수정할 수 있다. 그런 다음 운영체제가 완전히 컴파일된다.(`시스템 빌드`)

운영체제는 여전히 특정 하드웨어 구성을 위해 생성되지만 적재가능 커널 모듈과 같은 기술을 사용하면 시스템의 동적 변경을 위한 모듈방식을 지원할 수 있다.

Linux시스템을 처음부터 빌드하는 방법

-   http://www.kernel.org 에서 Linux소스코드를 다운로드 한다.
-   make menuconfig 명령을 사용하여 커널을 구성한다. - 이 단계는 .config 구성파일을 생성한다.
-   make 명령을 사용하여 메인 커널을 컴파일 한다.

    -   make 명령은 .config 파일에서 식별된 구성 매개변수를 기반으로 커널을 컴파일하여 커널 이미지인 vmlinuz파일을 생성한다.

-   make modules 명령을 사용하여 커널 모듈을 컴파일한다.

    -   커널 컴파일과 마찬가지로 모듈 컴파일은 .config파일에 지정된 구성 매개변수에 따라 다르다.

-   make modules install 명령을 사용하여 커널 모듈을 vmlinuz에 설치한다.
-   make install 명령을 입력하여 시스템에 새 커널을 설치한다.

대안으로 Linux 가상머신을 설치하여 기존 시스템을 수정할 수 있다. 그러면 호스트 운영체제 (Windows or MacOS)가 Linux를 실행할 수 있다.

## 2.9.2 시스템 부트

`커널을 적재하여 컴퓨터를 시작하는 과정을 시스템 부팅`이라고 한다.

-   `부트스트랩 프로그램 또는 부트로더`라고 불리는 작은 코드가 커널의 위치를 찾는다.
-   커널이 메모리에 적재되고 시작된다.
-   커널은 하드웨어를 초기화한다.
-   루트 파일 시스템이 마운트 된다.

일부 컴퓨팅 시스템은 다단계 부팅 과정을 사용한다.

-   컴퓨터 전원을 처음 켜면 BIOS라는 비휘발성 펌웨어에 있는 소형 부트 로더가 실행된다.

    -   이 초기 부트로더는 일반적으로 `부트 블록`이라고 하는 디스크의 정해진 위치에 있는 두 번째 부트 로더를 적재하는 작업만 한다.
    -   부트 블록에 저장된 프로그램은 전체 운영체제를 메모리에 적재하고 실행을 시작하기에 충분히 정교할 수도 있다.
    -   일반적으로, 이 부트 로더는 간단한 코드로써 (하나의 디스크 블록에 저장하기 위해) 디스크의 주소와 부트스트랩 프로그램의 나머지의 길이만 알고 있다.

-   많은 최신 컴퓨터 시스템이 BIOS 기반 부팅 과정을 UEFI(Unified Extensible Firmware Interface)로 대체하였다.
-   UEFI는 64비트 시스템과 용량이 큰 디스크를 더 잘 지원하는 것을 포함하여 BIOS에 비해 몇 가지 장점이 있다.

    -   UEFI가 하나의 완전한 부팅 관리자이므로 다단계 BIOS 부팅 과정보다 빠르다는 것

-   부트스트랩 프로그램은 BIOS든 UEFI에서 부팅하든 다양한 작업을 수행할 수 있다.
    -   커널 프로그램이 포함된 파일을 메모리에 적재하는 것 외에도 진단을 실시하여 메모리와 CPU를 점검하고 장치 검색과 같은 시스템 상태를 확인한다.
    -   진단을 통과하면 프로그램은 부팅과정을 계속 진행할 수 있다.
    -   부트스트랩은 CPU레지스터에서 장치 컨트롤러 및 메인 메모리의 내용에 이르기까지 시스템의 모든 측면을 초기화 할 수 있다.
    -   조만간 운영체제를 시작하고 루트 파일 시스템을 마운트 한다. (이 시점이 시스템이 `실행중`이라고 말할 수 있다.)

부트로더는 하드웨어 문제 진단, 손상된 파일 시스템 복구 및 운영체제 재설치 등의 작업할 수 있는 `복구모드`또는 `단일 사용자 모드`로 운영체제를 부팅할 수 있는 기능을 제공한다.
