# Direct Path I/O

일반적인 블록 I/O는 DB 버퍼 캐시를 경유한다. 읽고자 하는 블록을 먼저 버퍼 캐시에서 찾아보고 찾지 못할 때만 디스크에서 읽는다.

데이터 변경도 버퍼 캐시에 적재된 블록에서 이루어지며 DBWR프로세스가 주기적으로 변경된 블록(Dirty 버퍼블록)들을 데이터 파일에 기록한다.

재사용 가능성이 없는 임시 세그먼트 블록들을 읽고 쓸 때도 버퍼 캐시를 경유하지 않는 것이 유리하다.

오라클은 이럴 떄 버퍼 캐시를 경유하지 않고 곧바로 데이터 블록을 읽고 쓸 수 있는 Direct Path I/O 기능을 제공한다.

-   Temp 세그먼트 블록들을 읽고 쓸 때
-   병렬 쿼리로 Full Scan을 수행할때
-   nocache 옵션을 지정한 LOB컬럼을 읽을 때
-   direct 옵션을 지정하고 export를 수행할 때
-   parallel DML을 수행할 떄
-   Direct Path Insert를 수행할 때

## Direct Path Read/Write Temp

데이터를 정렬할 때는 PGA메모리에 할당되는 Sort Area를 이용한다. 정렬할 데이터가 많아 Sort Area가 부족해지면 Temp 테이블스페이스를 이용하는데 Sort Area에 정렬된 데이터를 Temp 테이블 스페이스에 쓰고 이를 다시 읽을 때 Direct Path I/O방식을 사용한다.

## Direct Path Read

병렬 쿼리로 Full Scan을 수행할 때도 Direct Path Read 방식을 사용한다. (그래서 병렬도 2로 설정해도 단순히 2배가 아니라 더 빨라지는 이유)

대용량 데이터를 읽을때는 Full Scan과 병렬 옵션을 적절히 사용함으로써 시스템 리소스를 적게 사용하도록 하는 것이 좋다.

버퍼 캐시에만 기록된 변경사항이 아직 데이터파일에 기록되지 않은 상태에서 데이터 파일을 직접 읽으면 정합성에 문제가 생긴다.

따라서 병렬로 Direct Path Read를 수행하려면 메모리와 디스크간 동기화를 먼저 수행함으로써 Dirty 버퍼를 해소해야 한다.

## Direct Path Write

Direct Path Write는 병렬로 DML을 수행하거나 Direct path Insert 방식으로 데이터를 insert 할 때 사용된다.

-   insert ... select 문장에 /_+ append_/ 힌트 사용
-   병렬모드로 insert
-   direct 옵션을 지정하고 SQL\*Loader로 데이터를 로드
-   CTAS(Create table as select)문장을 수행

일반적인 insert시에서 Freelist를 통해 데이터를 삽입할 블록을 할당받는다.

Freelist를 조회하면서 Random 액세스 방식으로 버퍼 캐시에서 해당 블록을 찾고 없으면 데이터파일에서 읽어 캐시에 적재한 후에 데이터를 삽입하므로 대량의 데이터를 insert 할 때 매우 느리다

Direct Path Insert시에는 Freelist를 참조하지 않고 테이블 세그먼트 또는 각 파티션 세그먼트의 HWM(High-Water Mark) 바깥 영역에 데이터를 순차적으로 입력한다.

Freelist로 부터 블록을 할당받는 작업이 생략될 뿐 아니라 insert할 블록을 버퍼 캐시에 적재하지 않고 데이터파일에 직접 insert하므로 일반적인 insert와는 비교할 수 없을 정도로 빠르다.

HWM 바깥영역에 데이터를 입력하므로 Undo 발생량도 최소화된다. (커밋하기 전까지 다른 세션에 읽히지 않으므로 Undo 데이터를 제공하지 않아도 되고 롤백할 때는 할당된 익스텐트에 대한 딕셔너리 정보만 롤백하면 되기 때문)

Direct Path Insert방식으로 데이터를 입력하면 Exclusive 모드 테이블 Lock이 걸린다는 것 병렬 방식으로 DML을 수행할 때도 마찬가지 (일반적인 DML 수행시에는 Row Exclusive 모드 테이블 Lock이므로 다른 트랜잭션의 DML을 막지 않음)

따라서 트랜잭션이 빈번한 주간에 이옵션을 사용하는 것은 절대 금물이다.
