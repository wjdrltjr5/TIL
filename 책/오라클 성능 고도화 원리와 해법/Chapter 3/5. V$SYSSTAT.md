# V$SYSSTAT

오라클은 성능 측정 지표로서 활용 가능한 항목들을 선정하고 SQL이 수행되는 동안 지속적으로 그 항목들에 대한 누적 통계치를 저장한다.

인스턴스 기동 후 현재까지 누적된 수행 통계치를 시스템 레벨로 확인하고자 할 떄 사용하는 뷰가 v$sesstat이다.

## 시스템 수행 통계 수집 및 분석

v$sysstat이나 v$sesstat에 나타나는 값들은 인스턴스 기동 후 또는 세션 수립 후 현재까지 누적된 값이므로 그 갑스이 크고 작음만으로 의미 있는 정보를 얻기는 어렵다.

이를 제대로 활용하는 방법은 두 구간 사이의 변화량을 구해 SQL 수행 도중에 내부적으로 어떤일들이 발생했는지 판명하는 것

작업을 수해할 세션과 더불어 별도로 세션을 하나 더 열어 아래 create문을 수행한다.

```sql
create table sess_stat
as
select 1 no, statistic#, value
from v$sesstat
where sid = &SID;
```

작업을 수행할 세션의 SID를 미리 알아놔야 하며, AutoTrace에서 설명했듯 별도의 세션을 이용하는 것은 v$sesstat를 조회해 insert할 때의 통계치가 섞이는 것을 방지하기 위함이다.

그후 본래의 세션에서 SQL문이나 배치 job을 수행한다. 작업이 완료되면 별도 세션에서 아래 insert 문을 수행하고 커밋한다.

```sql
insert into sess_stat
select 2 no, statistic#, value
from v$sesstat
where sid = %SID;

commit;
```

이제 수집된 수행통계를 쿼리해 두 구간 사이의 증분을 구해보면 작업 수행 도중 오라클 내부적으로 어떤 일들이 일어났는지 알 수 있다.

## Ratio 기반 성능 분석

위에서 수집된 수행 통게 자료를 이용해 DB의 전반적인 건강상태를 체크할 수 있는 의미 있는 Ratio 값들을 구할 수 있다.

자주 분석되는 항목들(주로 공유 리소스 사용빈도와 경합 발생 비율을 점검한다.)

-   Buffer Nowait %

    -   버퍼 블록을 읽으려 할 때 buffer busy waits 대기 없이 곧바로 읽기에 성공한 비율

-   Redo NoWait %

    -   Redo 로그를 기록할 공간을 요청하지 않고 곧바로 Redo 엔트리를 기록한 비율을 말한다.
    -   이 비율이 낮다면 로그 스위칭이 느리거나 너무 자주 발생함을 의미
    -   스위칭 횟수가 문제라면 Redo 로그 파일 크기를 증가시킬 필요가 있다.(아니라면 I/O서브시스템이 느린것)

-   Buffer Hit %

    -   버퍼 캐시에서 블록 찾기에 성공한 비율

-   Latch Hit %

    -   래치 경합 없이 첫 번째 시도에서 곧바로 래치를 획득한 비율을 말한다.

-   In-memory Sort %

    -   전체 소트 수행 횟수에서 in-memory 소트 방식으로 수행한 비율

-   Library Hit %

    -   이 항목부터 % Non-Parse CPU 까지는 파싱 부하와 관련있는 측정 항목들

    -   라이브러리 캐시 히트율은 Get 히트율과 Pin히트율로 나눌 수 있다.
    -   이항목은 Pin /Pin 히트율은 실행 단계와 관련있다.
    -   라이브러리 캐시에 이미 적재된 SQL 커서를 실행하거나 오브젝트 정보를 읽으려 할 때 커서 또는 오브젝트 정보가 힙 영역에서 찾아진다면 히트 성공
    -   참고로 get 히트율은 Parse단계와 관련있다. 이 수치가 낮다면 하드파싱 또는 최초 로드가 자주 발생

-   Soft Parse %

    -   실행 계획이 라이브러리 캐시에서 찾아져 하드 파싱을 일으키지 않고 SQL을 수행한 비율
    -   이항목이 낮다면 바인드 변수를 사용하도록 개선

-   Execute to Parse %

    -   Parse Call 없이 곧바로 SQL을 수행한 비율, 즉 커서를 애플리케이션에서 캐싱한 채 반복 수행한 비율

-   Parse CPU to Parse Elapsd %:

    -   파싱 총 소요 시간 중 CPU time이 차지한 비율
    -   파싱에 소요된 시간 중 실제 일을 수행한 시간 이값이 낮다면 대시시간이 많은 것

-   % Non-Parse CPU

    -   SQL을 수행하면서 사용잔 전체 CPU time 중 파싱 이외의 작업이 차지한 비율
    -   이 비율이 낮다면 파싱 과정에서 소비되는 CPU time 비율이 높은 것이므로 파싱 부하를 줄이도록 개선해야 한다.

-   Memory Usage %

    -   Shared Pool 내에서 현재 사용중인 메모리 비중

-   % SQL with executions > 1

    -   전체 SQL 개수에서 두 번 이상 수행된 SQL이 차지하는 비중
    -   이값이 낮다면 바인드 변수를 사용하지 않고 상수값을 이용하는 쿼리 수행빈도가 높은것

-   % Memory for SQL w/exec > 1
    -   전체 SQL이 차지하는 메모리 중 두번 이상 수행된 SQL이 차지하는 메모리 비중
    -   이값이 낮다면 바인드 변수를 사용하지 않고 상수값을 이용하는 쿼리 수행빈도가 높은것
