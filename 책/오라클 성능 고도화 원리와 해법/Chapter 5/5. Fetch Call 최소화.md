# Fetch Call 최소화

-   부분범위 처리 원리
-   OLTP 환경에서 부분범위처리에 의한 성능개선 원리
-   ArraySize 조정에 의한 Fetch Call 감소 및 블록 I/O감소효과
-   프로그램 언어에서 Array 단위 Fetch 기능 활용

## 부분범위처리 원리

DBMS도 데이터를 클라이언트에게 전송할 때 일정량씩 나누어 전송하며, 오라클의 경우 ArraySize(또는 Fetch Size) 설정을 통해 운반단위를 조절한다.

전체 결과집합 중 아직 전송하지 않은 분량이 많이 남아있어도 클라이언트로부터 추가 Fetch Call을 받기 전까지는 그대로 멈춰 서서 기다린다.

전체 데이터를 쉼 없이 연속적으로 처리하지 않고 사용자로부터 Fetch Call 있을 때마다 일정량씩 나누어서 전송하는 것을 `부분범위 처리`라고 한다.

데이터의 운반단위는 적당한 게 좋다.

## OLTP 환경에서 부분범위처리에 의한 성능개선 원리

OLTP 환경에서는 결과 집합이 많을수록 오히려 성능이 더 좋아진다.

```sql
--1
select /*+ index(t t_pk) */ from t where x > 0 and mod(y, 50) = 0
--2
select /*+ index(t t_pk) */ from t where x > 0 and mod(y, 500000) = 0
```

1번쿼리는 500건을 스캔할때마다 한번씩 전송명령을 날린다 2번 쿼리는 500000건당 한 번씩이므로 그만큼 클라이언트 측 Array 버퍼를 채우는데 시간이 많이 걸려 출력 도중 끊기는 현상이 생긴다.

출력 대상 건이 많을 수록 Array를 빨리 채울 수 있어 쿼리 응답속도도 그만큼 빨라진다.

인덱스와 부분범위처리 원리를 잘 활용하면 OLTP 환경에서 극적인 성능개선 효과를 얻을 수 있는 원리

데이터가 많을수록 더 빨라진다는 의미는 부분범위처리가 가능한 업무에 한하며 서버가공 프로그램이나 DW성 쿼리처럼 결과 집합 전체를 Fetch해야 한다면 결과 집합이 많을수록 더 빨라지는 일은 있을 수 없다.

## ArraySize 조정에 의한 Fetch Call 감소 및 블록 I/O 감소 효과

대량데이터를 내려받았을 때 ArraySize를 크게 설정할 수록 Fetch Call 횟수가 줄어 네트워크 부하가 감소하고 쿼리 성능이 향상된다. 뿐만 아니라 서버 프로세스가 읽어야 할 블록 개수까지 줄어드는 일거양득의 효과를 얻게 된다.

블록 I/O가 줄어드는 이유는 한개의 블록에 5개의 레코드가 있다고 가정 Array Size가1이면 5번 2이면 3번 3이면 2번 이런식으로 줄어듬

## 프로그램 언어에서 Array 단위 Fetch 기능 활용

자바에서 FetchSize조정시

-   최초 rs.next() 호출시 한꺼번에 100건을 가져와서 클라이언트 Array버퍼에 캐싱

-   이후 rs.next() 호출시 데이터베이스 call을 발생시키지 않고 Array버퍼에서 읽는다.

-   버퍼에 캐싱되있던 모든 데이터를 소진후 101번째 rs.next()시 다시 100건을 가져온다.

-   결과를 다읽을 때까지 반복
