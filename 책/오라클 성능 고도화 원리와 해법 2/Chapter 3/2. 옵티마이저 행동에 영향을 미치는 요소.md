# 옵티마이저 행동에 영향을 미치는 요소

옵티마이저 행동의 차이는 궁극적으로 실행계획의 차이를 말하며, 실행계획에 영향을 미치는 요소로는 아래와 같은 것들이 있다.

-   SQL과 연산자 형태
-   인덱스, IOT, 클러스터링, 파티셔닝, MV등 옵티마이징 팩터
-   제약설정 : PK, FK, Not Null, Check
-   옵티마이저 힌트
-   통계정보 : 오브젝트 통계, 시스템 통계
-   옵티마이저 관련 파라미터
-   DBMS 버전과 종류

## SQL과 연산자 형태

결과가 같더라도 SQL을 어떤 형태로 작성했는지 또는 어떤 연산자를 사용했는지에 따라 옵티마이저가 다른 선택을 할 수 있고, 궁극적으로 쿼리 성능에 영향을 미친다.

## 인덱스, IOT, 클러스터링, 파티서닝, MV등 옵티마이징 팩터

쿼리를 똑같이 작성하더라도 인덱스, IOT, 클러스터링, 파티셔닝, MV등을 구성했는지 그리고 어떤 식으로 구성했는지에 따라 실행계획과 성능이 크게 달라진다.

## 제약설정

데이터베이스가 논리적으로 의미 있는 자료만을 포함하도록 하는 데이터 무결성 규칙으로는 아래 4가지가 있다.

-   개체무결성
-   참조무결성
-   도메인무결성
-   사용자 정의 무결성

이들 규칙을 애플리케이션으로 구현할 수도 있지만 DBMS가 제공하는 PK, FK, Check, Not Null 같은 제약설정 기능을 이용해야 완벽한 데이터 무결성을 확보할 수 있다.

제약 설정은 데이터 무결성을 보장해 줄뿐만 아니라 옵티마이저가 쿼리 성능을 최적화하는데 매우 중요한 정보를 제공한다.

### PK 제약과 옵티마이저

서브쿼리를 Unnesting 하고서 고객 테이블을 기준으로 NL조인하려 할 때, 만약 고객 테이블에 PK 제약이 없다면 고객번호 중복을 제거하는 sort unique 오퍼레이션을 먼저 수행해야 한다.

실제 고객번호에 중복 값이 없더라도 옵티마이저에게 그런 사실을 알려주지 않으면 소용이 없다.

(수정가능 조인뷰에서도 1쪽 테이블에 PK 제약이 있어야 하던 것처럼)

### FK 제약과 옵티마이저

(4.6 조인제거,)
FK제약이 있을때만 작동하는 여러 기능들이 있다. (ex. 11g부터 생긴 Reference 파티셔닝)

### Not Null 제약과 옵티마이저

```sql
-- 부서별 사원수 집계 쿼리
select deptno, count(*) from emp group by deptno;
```

옵티마이저가 이 쿼리를 최적화할 때 deptno 컬럼에 인덱스가 있으면 index full scan또는 index fast full scan으로 빠르게 처리할 수 있다.

하지만 deptno 컬럼에 not null제약이 있을때나 가능

not null 제약을 설정하지 않으면 옵티마이저는 null 값이 입력될 가능성을 염두에 두고 실행계획을 수립해야 하므로 테이블 전체를 스캔한다.

업무적으로 이 컬럼에 null 값을 허용하지 않더라도 옵티마이저에게 그런 사실을 알려주지 않으면 소용없는 것

### Check 제약과 옵티마이저

옵티마이저도 쿼리를 제적화할때 이 정보를 이용한다. 예로 check로 인한 유효값으로 5000 이하를 적용했을때 5000을 초과하는 정보를 조회할경우 filter 조건을 추가해 불필요한 I/O가 수행되지 않도록 한다.

### 옵티마이저 힌트

옵티마이저는 아래와 같은 경우가 아니면 힌트를 가장 우선적으로 따른다.

-   문법적으로 맞지 않게 힌트를 기술
-   잘못된 참조 사용
-   의미적으로 맞지 않게 힌트를 기술
-   논리적으로 불가능한 액세스 경로
-   버그

위 경우에 해당하지 않는 한 옵티마이저는 기본적으로 힌트의 내용을 먼저 따르고 남은 부분만을 자신의 판단에 따라 최적화한다는점

옵티마이저 힌트에 관한 일반적인 사용 원칙은 다음과 같다.

-   가급적 힌트 사용을 자제하고, 옵티마이저가 스스로 좋은 선택을 할 수 있도록 돕는다.
-   옵티마이저가 잘못된 선택을 할 때만 힌트를 사용한다.

위 기준은 일반적인 기준으로 오히려 힌트를 적극적으로 사용해야 하는 시스템 환경도 많다.

힌트를 사용하지 않으면 데이터 특성 변화에 따라 실행계획이 유연하게 바뀔 수 있는 장점이 있지만 그런 유연성이 오히려 치명적인 결과를 가져올 수 있기 떄문이다.

### 통계정보

통계정보는 중요하고, 옵티마이저에게 미치는 영향이 절대적이다.

CBO의 모든 판단 기준은 통계정보에서 나온다. 통계정보가 없으면 작동하지 않는 기능들도 많다.

이에 대한 정확한 이해 없이는 데이터베이스 성능 문제를 다루는 것 자체가 불가능할 정도로 최신 옵티마이저는 통게정보를 중심으로 움직인다.

## 옵티마이저 관련 파라미터,

SQL, 데이터, 통계정보, 하드웨어 등 모든 환경이 동일한데오 오라클 버전을 업그레이드하면 옵티마이저가 다르게 작동하는 경험을 누구나 한다.

옵티마이저의 그런 행동 변화는 대개 파라미터의 추가 또는 변경을 통해 이루어진다.

## DBMS 버전과 종류

옵티마이저의 관련 파라미터와 상관없이 버전에 따라 다른 실행계획을 수립하는 경우도있다.

같은 형태의 SQL인데도 DBMS 종유에 따라 내부적으로 처리하는 방식에 차이가 있다.
