# 통계정보 1

실행계획을 수립할 때 CBO는 SQL문장에서 액세스할 데이터 특성을 고려하기 위해 통계정보를 이용한다.

따라서 최적의 실행계획을 위해서는 통계정보가 데이터 상태를 정확하게 반영하도록 관리해 주어야 한다.

옵티마이저가 참조하는 통계정보 종류로 네가지가 있다.

-   테이블 통계
-   인덱스 통계
-   컬럼 통계(히스토그램 포함)
-   시스템 통계

## 테이블 통계

테이블 통계만 수집할 때는 아래 명령어를 사용하며,

-   compute는 전수 검사
-   estimate는 표본 조사를 뜻한다.

```sql
analyze table emp compute statistics for TABLE;
analyze table emp estimate statistics sample 5000 rows for TABLE;
analyze table emp estimate statistics sample 50 percent for TABLE
```

`통계정보를 수집할 때 이제는 analyze 명령어를 사용하지 말라는 것이 오라클의 공식적인 입장.`(지금은 테이블, 인덱스, 컬럼 통계를 따로 보기 위해 사용)

`오라글이 권장하는 통계 수집방식은 dbms_stats 패키지 사용`

## 인덱스 통계

인덱스 통계를 수집할 떄는 아래 명령어를 사용한다.

```sql
analyze INDEX emp_pk compute statistics;
```

테이블에 속한 모든 인덱스 통계를 수집할 때는 아래 명령어를 사용한다.

```sql
analyze table emp compute statistics for ALL INDEXES;
```

테이블과 인덱스 통계를 함께 수집하려면 아래와 같이 한다.

```sql
analyze table emp compute statistics from TABLE for ALL INDEXES;
```

인덱스를 최초 생성하거나 재생성할때 아래와 같이 compute statistics 옵션을 주면 자동으로 인덱스 통계까지 수집된다.

인덱스는 이미 정렬돼 있으므로 통계정보 수집에 오랜시간이 소요되지 않는다.

```sql
create index emp_ename_idx on emp(ename) COMPUTE STATISTICS;

alter index emp_ename_idx rebuild COMPUTE STATISTICS;
```

10g부터는 사용자가 이 옵션을 명시하지 않아도 오라클이 알아서 인덱스 통계까지 수집해준다.

## 컬럼 통계

아래는 테이블, 인덱스 통계는 제외하고 컬럼 통계만 수집하는 방법이다.

```sql
analyze table emp compute statistics for ALL COLUMNS SIZE 254;
```

size 옵션은 히스토그램의 최대 버킷 개수를 지정하는 옵션으로서, 1~254까지 허용된다.

size를 명시하지 않으면 오라클이 75를 기본값으로 사용하므로 히스토그램이 생성되지 않도록 하고 싶을 때는 size 옵션을 1로 명시해야 한다.

일부 컬럼에 대한 통계만 수집할 때는 아래와 같이 한다.

```sql
analyze table emp compute statistics for COLUMNS ENAME SIZE 10, SAL SIZE 20;
```

히스토그램 버킷 개수를 컬럼별로 지정하지 않고 똑같이 20으로 지정할 때는 아래와 같이 하면된다.

```sql
analyze table emp compute statistics for size 20 ENAME, SAL, HIREDATE;
```

테이블, 인덱스, 컬럼 통계를 아래와 같이 동시에 수집할 수도 있다.

```sql
analyze table emp compute statistics
for table
for all indexes
for all indexed columns size 254;
```

dbms_stats 패키지로 컬럼 통계만 따로 수집하는 방법은 없다. 테이블 통게와 항상 같이 수집된다.

## 시스템 통계

시스템 통계는 I/O, CPU 성능 같은 하드웨어적 특성을 측정한 것으로서, 아래와 같은 항목들을 포함한다.

-   CPU 속도
-   평균적인 Single Block I/O 속도
-   평균적인 Multi Block I/O 속도
-   평균적인 Multi Block I/O 개수
-   I/O 서브시스템의 최대 처리량
-   병렬 Slave의 평균적인 처리량

시스템 사양뿐만 아니라 애플리케이션이 OLTP성이나 DW성이냐에 따라서도 위 항목의 특성이 달라지므로 옵티마이저 개발팀의 테스트 환경과 다른 환경이라면 최적이 아닌 실행계획을 수립할 가능성이 높아진다.

### Workload 시스템 통계

Workload 시스템 통계는, 애플리케이션으로부터 일정 시간 동안 발생한 시스템 부하를 측정, 보관함으로써 그 특성을 최적화 과정에 반영할 수 있게 한 기능

수집하는 동안 애플리케이션이 I/O 집약적인 쿼리를 주로 수행했다면 통계정보에 그것이 반영될 것이므로 이를 적용한 이후 옵티마이저는 덜 I/O 집약적인 실행계획을 선택할 것이다.

Workload 시스템 통계 항목에는 6가지가 있다.

-   cpuspeed : 현재 시스템에서 단일 CPU가 초당 수행할 수 있는 표준 오퍼레이션 개수 ( 단위 : 백만 / 초)

-   sreadtim : 평균적인 single block I/O 속도 (단위 : ms = 1/1000초)

-   mreadtim : 평균적인 Multiblock I/O 속도 (단위 : ms = 1/1000초)

-   mbrc : Multiblock I/O 방식을 사용할 떄 평균적으로 읽은 블록 수
-   maxthr : I/O 서브시스템의 최대 처리량(단위 : 바이트/초)
-   slavethr : 병렬 slave의 평균적인 처리량(단위 : 바이트/초)

NoWorkload 시스템 통계는 오라클이 무작위로 I/O를 발생시켜 측정한 값인 반면 Workload 시스템 통계는 실제 애플리케이션에서 발생하는 부하를 측정한 값이다.

만약 수집기간 동안 애플리케이션에서 Full Table Scan이 발생하지 않는다면 mreadtime, mbrc 항목이 측정되지 않고 병렬 쿼리가 수행되지 않는다면 slaverthr 항목이 측정되지 않는다.

따라서 workload 시스템 통계를 제대로 활용하려면 통계 수집 전략을 잘 세워야 한다

### NoWorkload 시스템 통계

관리자가 명시적으로 선택하지 않더라도 CPU 비용 모델이 기본 비용 모델로 사용되게 하려고 오라클 10g에서 NoWorkload 시스템 통계를 도입하였다.

CPU 비용 모델은 시스템 통계가 있을 때만 활성화 되기 때문

NoWorkload 시스템 통계 항목과(처음 데이터베이스를 기동할 때 설정되는) 기본 값은 다음과 같다.

-   cpuspeednw

    -   기본값 : 데이터베이스 최초 기동 시 측정된 값
    -   NoWorkload 상태에서 측정된 CPU 속도( 단위 : Milions/sec)

-   ioseektim

    -   기본값 : 10ms
    -   데이터를 읽으려고 디스크 헤드를 옮기는데 걸린 시간

-   iotfrspeed :
    -   기본값 : 4096 bytes/ms
    -   I/O Transfer 속도를 뜻하며 하나의 OS프로세스가 I/O 서브시스템으로부터 데이터를 읽는 속도

Workload 시스템 통계를 수집하고 반영하는 순간 NoWorkload 시스템 통계는 무시된다.

Workload 시스템 통계가 수집되기 전까지는 아래 공식을 이용해 추정된 값을 사용한다.

-   cpuspeed = cpuspeednw
-   sreadtim = ioseektim + db_block_size / iotfrspeed

-   mreadtim = ioseektim + mbrc \* db_block_size / iotfrspeed
-   mbrc = db_file_multiblock_read_count

시스템 통계를 제대로 활용하려면 Workload 시스템 통계가 바람직하지만 이를 수집하기 어려운 환경이 존재하며, 그럴 때 NoWorkload 시스템 통계를 사용한다.

시스템 통계는 프로젝트 초기, 늦어도 단위 테스트 전에는 확정돼야 하는데 그 시점에 의미 있게 부하 테스트 시나리오를 만들기 어려울 때가 많다.

`어떤 이유에서건 NoWorkLoad 시스템 통계를 이용하기로 했다면 기본 설정 값을 그대로 사용하지 말고 적당한 부하를 준 상태에서 NoWorkload 시스템 통계를 수집해 주어야 한다.`

NoWorkload는 부하가 없는 상태에서 수집하는 것이라고 오해하기 쉬운데, Workload와 마찬가지로 부하를 준 상태에서 측정된 값을 사용해야 시스템 통계로서 의미가 있다.

Workload 통계와의 주요 차이점은 통계를 수집하는 방식에 있다.

`Workload는 실제 애플리케이션에서 발생하는 부하를 기준으로 각 항목의 통계치를 측정`

`NoWorkload는 모든 데이터 파일 중에서 오라클이 무작위로 I/O를 발생시켜 통계를 수집한다.`

따라서 시스템 부하정도가 심할 때 NoWorkload 시스템 통계를 수집하면 구해진 값들도 달라진다.
