# 통계정보 1

실행계획을 수립할 때 CBO는 SQL문장에서 액세스할 데이터 특성을 고려하기 위해 통계정보를 이용한다.

따라서 최적의 실행계획을 위해서는 통계정보가 데이터 상태를 정확하게 반영하도록 관리해 주어야 한다.

옵티마이저가 참조하는 통계정보 종류로 네가지가 있다.

-   테이블 통계
-   인덱스 통계
-   컬럼 통계(히스토그램 포함)
-   시스템 통계

## 테이블 통계

테이블 통계만 수집할 때는 아래 명령어를 사용하며,

-   compute는 전수 검사
-   estimate는 표본 조사를 뜻한다.

```sql
analyze table emp compute statistics for TABLE;
analyze table emp estimate statistics sample 5000 rows for TABLE;
analyze table emp estimate statistics sample 50 percent for TABLE
```

`통계정보를 수집할 때 이제는 analyze 명령어를 사용하지 말라는 것이 오라클의 공식적인 입장.`(지금은 테이블, 인덱스, 컬럼 통계를 따로 보기 위해 사용)

`오라글이 권장하는 통계 수집방식은 dbms_stats 패키지 사용`

## 인덱스 통계

인덱스 통계를 수집할 떄는 아래 명령어를 사용한다.

```sql
analyze INDEX emp_pk compute statistics;
```

테이블에 속한 모든 인덱스 통계를 수집할 때는 아래 명령어를 사용한다.

```sql
analyze table emp compute statistics for ALL INDEXES;
```

테이블과 인덱스 통계를 함께 수집하려면 아래와 같이 한다.

```sql
analyze table emp compute statistics from TABLE for ALL INDEXES;
```

인덱스를 최초 생성하거나 재생성할때 아래와 같이 compute statistics 옵션을 주면 자동으로 인덱스 통계까지 수집된다.

인덱스는 이미 정렬돼 있으므로 통계정보 수집에 오랜시간이 소요되지 않는다.

```sql
create index emp_ename_idx on emp(ename) COMPUTE STATISTICS;

alter index emp_ename_idx rebuild COMPUTE STATISTICS;
```

10g부터는 사용자가 이 옵션을 명시하지 않아도 오라클이 알아서 인덱스 통계까지 수집해준다.

## 컬럼 통계

아래는 테이블, 인덱스 통계는 제외하고 컬럼 통계만 수집하는 방법이다.

```sql
analyze table emp compute statistics for ALL COLUMNS SIZE 254;
```

size 옵션은 히스토그램의 최대 버킷 개수를 지정하는 옵션으로서, 1~254까지 허용된다.

size를 명시하지 않으면 오라클이 75를 기본값으로 사용하므로 히스토그램이 생성되지 않도록 하고 싶을 때는 size 옵션을 1로 명시해야 한다.

일부 컬럼에 대한 통계만 수집할 때는 아래와 같이 한다.

```sql
analyze table emp compute statistics for COLUMNS ENAME SIZE 10, SAL SIZE 20;
```

히스토그램 버킷 개수를 컬럼별로 지정하지 않고 똑같이 20으로 지정할 때는 아래와 같이 하면된다.

```sql
analyze table emp compute statistics for size 20 ENAME, SAL, HIREDATE;
```

테이블, 인덱스, 컬럼 통계를 아래와 같이 동시에 수집할 수도 있다.

```sql
analyze table emp compute statistics
for table
for all indexes
for all indexed columns size 254;
```

dbms_stats 패키지로 컬럼 통계만 따로 수집하는 방법은 없다. 테이블 통게와 항상 같이 수집된다.

## 시스템 통계

시스템 통계는 I/O, CPU 성능 같은 하드웨어적 특성을 측정한 것으로서, 아래와 같은 항목들을 포함한다.

-   CPU 속도
-   평균적인 Single Block I/O 속도
-   평균적인 Multi Block I/O 속도
-   평균적인 Multi Block I/O 개수
-   I/O 서브시스템의 최대 처리량
-   병렬 Slave의 평균적인 처리량

시스템 사양뿐만 아니라 애플리케이션이 OLTP성이나 DW성이냐에 따라서도 위 항목의 특성이 달라지므로 옵티마이저 개발팀의 테스트 환경과 다른 환경이라면 최적이 아닌 실행계획을 수립할 가능성이 높아진다.

### Workload 시스템 통계

Workload 시스템 통계는, 애플리케이션으로부터 일정 시간 동안 발생한 시스템 부하를 측정, 보관함으로써 그 특성을 최적화 과정에 반영할 수 있게 한 기능

수집하는 동안 애플리케이션이 I/O 집약적인 쿼리를 주로 수행했다면 통계정보에 그것이 반영될 것이므로 이를 적용한 이후 옵티마이저는 덜 I/O 집약적인 실행계획을 선택할 것이다.

Workload 시스템 통계 항목에는 6가지가 있다.
