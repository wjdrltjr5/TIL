# 카디널리티

옵티마이저의 복잡한 비용 계산 원리를 꼭 알 필요는 없다. 안다고 해서 튜닝을 잘하는 것도 아니다.

하지만 통게정보 수집전략의 필요성을 느끼는데는 도움이 된다.

인덱스, 클러스터 등 옵티마이징 팩터가 동일한 상황에서 CBO 행동에 결정적 영향을 미치는 요소는 무엇보다 통계정보다.

고성능 데이터베이스를 구축하는 데 있어 정확하고 안정적인 통계정보를 제공하는 일은 무엇보다 중요하다.

## 선택도

`선택도는 전체 대상 레코드 중에서 특정 조건에 의해 선택될 것으로 예상하는 레코드의 비율을 말한다.`

선택도를 가지고 카디널리티를 구하고, 다시 비용을 구함으로써 인덱스 사용여부, 조인 순서와 방법 등을 결정하므로 선택도는 최적의 실행계획을 수립하는 데 있어 가장 중요한 요인이라고 할 수 있다.

> 선택도 -> 카디널리티 -> 비용 -> 액세스방식, 조인 순서, 조인 방법 등 걸정

히스토그램이 있으면 그것으로 선택도를 산정하며, 단일 컬럼에 대해서는 정확도도 비교적 높다.

히스토그램이 없거나 있더라고, 조건절에 바인드 변수를 사용하면 옵티마이저는 데이터 분표가 균일하다고 가정한 상태에서 선택도를 구한다.

히스토그램 없이 등치(=) 조건에 대한 선택도를 구하는 공식은 다음과 같다.

> 선택도 = 1 / DistinctValue 개수 = 1 / num_distinct

히스토그램 없이 부등호, between 같은 범위검색 조건에 대한 선택도를 구하는 기본 공식은 다음과 같다.

> 선택도 = 조건절에서 요청한 값 범위 / 전체 값 범위

분자, 분모에 사용된 두 개의 값 범위는 컬럼 통계로서 수집된 high_value, low_value, num_distinct 등을 이용해 구한다.

`컬럼 히스토그램이 없을때 옵티마이저는 조건절에서 요청한 값 범위에 속한 값들이 전체 값 범위에 고르게 분포돼 있음을 가정하고 선택도를 구한다.`

히스토그램을 생성했더라도 바인드 변수를 사용하면 평균적인 분포를 가정해 카디널리티를 구한다.

## 카디널리티

`카디널리티는 특정 액세스 단계를 거치고 나서 출력될 것으로 예상되는 결과 건수를 말하며, 아래와 같이 총 로우 수에 선택도를 곱해서 구한다.`

> 카디널리티 = 총 로우 수 \* 선택도

컬럼 히스토그램이 없을때 = 조건에 대한 선택도가 1/num_distinct이므로 카디널리티는 아래와 같이 구해진다.

> 카디널리티 = 총 로우 수 \* 선택도 = num_rows / num_distinct

num_rows는 테이블 통계에서 , num_distinct는 컬럼 통계에서 확인할 수 있다.

-   테이블 통계 : dba_tables, dba_tab_statistics
-   컬럼 통계 : dba_tab_columns, dba_tab_col_statistics

## NULL 값을 포함할 때

```sql
select * from t_emp where job is null;
```

```sql
select * from t_emp where job = null;
```

등치 조건으로 비교할 때 양쪽값이 모드 null이면 참을 반환하도록 옵션을 제공하는 DBMS도 있지만 오라클은 이를 허용하지 않는다.

위 두 쿼리의 결과는 다르며 두번째 쿼리는 항상 공집합니다.

아래와 같은 조건식일때 바인드 변수에 어떤 값이 입력되든(null이 입력되더라도) job이 null인 레코드는 결과집합에서 제외된다.

```sql
select * from t_emp where job = :job
```

= 조건에 대한 선택도를 구할 때 이런 특성을 반영하려면 기존 공식에 null이 아닌 로우비중을 곱하고, 문모인 Distinct Value에 null값을 제외시키면 된다.

## 조건절이 두 개 이상일 때

조건절이 두 개 이상일 때의 카디널리티 구하는 공식은 간단하다. 각 컬럼의 선택도와 전체 로우 수를 곱해 주기만 하면된다.

job과 deptno 컬럼의 선택도가 각각 0.1, 0.33 일때 옵티마이저가 구한 카디널리티는 33(1000 _ 0.1 _ 0.33)일 것이다. 1000은 총 로우수

## 범위 검색 조건일 때

> 선택도 = 조건절에서 요청한 값 범위 / 전체 값 범위

공식에서 알 수 있듯이 옵티마이저는 조건절에서 요청한 범위에 속한 값들이 전체 값 범위에 고르게 분포돼있음을 가정한다.

## cardinality 힌트를 이용한 실행계획 제어

옵티마이저가 계산한 카디널리티가 부정확할 때는 힌트를 이용해 사용자가 직접 카디널리티 정보를 제공할 수 있다.

```sql
select /*+ use_hash(d e) cardinality(d 16)*/ *
  from dept d, emp e
 where d.deptno = e.deptno
```
