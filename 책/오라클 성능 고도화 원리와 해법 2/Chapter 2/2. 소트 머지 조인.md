# 소트 머지 조인

## 기본 메커니즘

NL 조인을 효과적으로 수행하려면 조인 컬럼에 인덱스가 필요하다. 만약 적절한 인덱스가 없다면 Inner 테이블을 탐색할 때마다 반복적으로 Full Scan을 수행하므로 매우 비효율적이다.

그럴떄 옵티마이저는 소트 머지 조인이나 다음 절에서 설명할 해시 조인을 고려한다.

소트 머지 조인은 아래 두 단계로 진행된다.

1. 소트 단계 : 양쪽 집합을 조인 컬럼 기준으로 정렬한다.
2. 머지 단계 : 정렬된 양쪽 집합을 서로 머지한다.

`소트 머지 조인은 Outer 루프와 Inner 루프가 Sort Area에 미리 정렬해 둔 자료구조를 이용한다는 점만 다를 뿐, 실제 조인 오퍼레이션을 수행하는 과정은 NL조인과 다르지 않다.`

Sort Area는 PGA 영역에 할당되므로 SGA를 경유해 인덱스와 테이블을 액세스할 때보다 훨씬 빠르다.

PGA는 프로세스만을 위한 독립적인 메모리 공간이어서 데이터를 읽을 때 래치 획득 과정이 없기 떄문

테이블이 정렬돼 있기 떄문에 조인에 실패하는 레코드를 만나는 순간 멈출 수 있다(Inner table).

스캔 시작점을 찾으려고 매번 탐색하지 않아도 된다. 2번 스캔은 1번 스캔하다가 멈춘 지점을 기억했다가 거기서부터 시작하면 된다.

Outer 테이블도 같은 수선로 정렬돼 있기 때문에 가능한 일

## 소트 머지 조인의 특징

소트 머지 조인은 조인을 위해 실시간으로 인덱스를 생성하는 것과 다름없다.

양쪽 집합을 정렬한 다음에는 NL 조인과 같은 방식으로 진행하지만 PGA 영역에 저장된 데이터를 이용하기 때문에 빠르다

따라서 소트 부하만 감수한다면 건건이 버퍼 캐시를 거치면서 조인하는 NL 조인보다 유리하다. (하지만 버퍼 Pinning 때문에 NL조인도 조금씩 유리하지기 시작)

양쪽 집합을 개별적으로 읽고나서 조인한다는 것도 특징이다. 따라서 조인 컬럼에 인덱스가 없는 상황에서 두 테이블을 독립적으로 읽어 조인 대상 집합을 줄일 수 있을 때 아주 유리하다.

스캔 위주의 액세스 방식을 사용한다는 것도 소트 머지 조인의 중요한 특징

하지만 모든 처리가 스캔 방식으로 이루어지는 것은 아니다. 양쪽 소스 집합에서 정렬 대상 레코드를 찾는 작업만큼은 인덱스를 이용해 Random 액세스 방식으로 처리될 수 있고

그때 발생하는 Random 액세스 량이 많다면 소트 머지 조인의 이점이 사라질 수도 있다. (해시 조인도 마찬가지)

대부분 해시 조인보다 느린 성능을 보이지만 아래와 같은 상황에서는 여전히 소트 머지 조인이 유용하다.

-   First 테이블에 소트 연산을 대체할 인덱스가 있을때
-   조인할 First 집합이 이미 정렬돼있을 때
-   조인 조건식이 등치 조건이 아닐 때

## First 테이블에 소트 연산을 대체할 인덱스가 있을 때

소트 머지 조인은 무조건 전체범위 처리 방식이라고 알려졌지만 항상 그렇지는 않다.

해시 조인과 마찬가지로 한쪽 집합(Inner, Second)은 전체 범위를 처리하고 다른 한쪽(Outer, First)은 일부만 읽고 멈추도록 할 수 있다.

First 테이블 조인 컬럼에 인덱스가 있을 때 그렇다. 만약 그렇게 처리할 수 있다면 OLTP성 업무에서 소량의 테이블과 대량의 테이블을 조인할 떄 소트 머지 조인을 유용하게 사용할 수 있다.

소트 머지 조인에서 인덱스를 이용해 소트 연산을 대체할 수 있는 대상은 First 테이블에만 국한된다.

Second 테이블 조인 컬럼에 대한 인덱스를 이용함에도 Sort Join 오퍼레이션이 나타나지만, 이때는 소트 연산에 의한 부하가 크지 않다.

항상 First 테이블을 먼저 읽는 것은 아니다. First 테이블은 이미 정렬된 인덱스를 사용할 것이므로 그대로 두고. Second 집합 테이블을 읽어 정렬한 결과를 Sort Area에 담는다.

인덱스를 이용해 정렬연산을 생략하면 좋은 성능을 볼 수 있다.

## 조인할 First 집합이 이미 정렬돼 있을 때

소트 머지 조인할 때, First쪽 집합이 조인 컬럼 기준으로 이미 정렬된 상태일 수 있다.

group by, order by, distinct 연산 등을 먼저 수행한 경우인데, 그때는 조인을 위해 다시 정렬하지 않아도 되므로 소트 머지 조인이 유리하다.

First 집합이 정렬돼 있을 때만 소트 연산이 생략되며, Second 집합은 설사 정렬돼 있더라고 Sort Join 오퍼레이션을 수행한다.

## 조인 조건식이 등치(=) 조건이 아닐때

해시 조인은 조인 조건식이 등치 조건일 때만 사용할 수 있지만 소트 머지 조인은 등치 조건이 아닐 때도 사용될 수 있다.
