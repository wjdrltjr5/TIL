# Sort Area 크기 조정

세션 레벨에서 Sort Area크기를 조정하거나, 시스템 레벨에서 각 세션에 할당될 수 있는 총 크기를 조정해야 할 떄가 있다.

SortArea 크기 조정을 통한 튜닝의 핵심은 디스크 소트가 발생하지 않도록 하는 것을 1차 목표로 삼고 불가피 할때는 Onepass 소트로 처리되도록 하는데에 있다.

## PGA 메모리 관리 방식의 선택

데이터 정렬, 해시 조인, 비트맵 머지, 비트맵 생성 등을 위해 사용하는 메모리 공간을 WorkArea라고 부르며 sort_area_size, hash_area_size, bitmap_merge_area_size, create_bitmap_area_size 같은 파라미터를 통해 조정한다.

9i부터는 자동 PGA 메모리 관리 기능이 도입되었기 때문에 사용자가 일일이 그 크기를 조정하지 않아도 된다.

DB관리자는 pga_aggregate_target 파라미터를 통해 인스턴스 전체적으로 이용 가능한 PGA 메모리 총량을 지정하기만 하면 된다.

그러면 오라클이 시스템 부하 정도에 따라 자동으로 각 세션에 메모리를 할당해 준다.

이 파라미터 설정은 인스턴스 기동 중에 자유롭게 늘리거나 줄일 수 있다.

만약 트랜잭션이 거의 없는 야간에 대량의 배치 JOB을 수행할때는 수동방식으로 변경하고 직접 크기를 조정하는 것이 효과적이다.

자동 PGA 메모리 관리방식하에서는 프로세스당 사용할 수 있는 최대 크기가 제한된다.

## 자동 PGA메모리 관리 방식 하에서 크기 결정 공식

auto 모드에서 단일 프로세스가 사용할 수 있는 최대 work area 크기는 인스턴스 기동 시 오라클에 의해 내부적으로 결정되며, \_smm_max_size파라미터를 통해 확인 가능하다.

이 파라미터 값을 결정하는 내부 계산식은 버전에 따라 다르다.
(618p)

SGA는 sga_max_size 파라미터로 설정된 크기만큼 공간을 미리 할당한다.

이와 대조적으로 PGA는 자동 PGA메모리 관리 기능을 사용한다고 해서 pga_aggregate_target 크기만큼의 메모리를 미리 할당해 두지는 않는다.

이 파라미터는 workarea_size_policy를 auto로 설정한 모든 프로세스들이 할당 받을 수 있는 work area의 총량을 제한하는 용도로 사용한다.

## 수동 PGA 메모리 관리 방식으로 변경 시 주의 사항

manual 모드로 설정한 프로세스는 pga_aggregate_target 파라미터의 제약을 받지 않는다.

따라서 manual모드로 설정한 많은 세션에서 Sort Area와 Hash Area를 아주 큰 값으로 설정하고 실제 매우 큰 작업을 동시에 수행한다면 가용한 물리적 메모리가 고갈돼 페이징이 발생하면서 시스템 전체 성능을 크게 떨어뜨릴 수 있다.

페이징이 심하면 시스템을 마비시킬 수도 있으므로 이들 파라미터를 수동으로 변경할때는 그런 상황이 발생하지 않도록 세심한 주의를 기울어야 한다.

sort order by나 해시 조인등을 수행할 때는 사용자가 지정한 DOP(the degree of parallelism)의 2배수만큼의 병렬 slave가 떠서 작업을 수행하므로 위 쿼리가 수행되는 동안 128개의 프로세스가 각각 최대 2GB의 Sort Area를 사용할 수 있다.

## PGA_AGGREGATE_TARGET의 적정 크기

pga_aggregate_target 파라미터 설정을 위한 오라클이 권장하는 적정 크기는 다음과 같다.

-   OLTP 시스템 : (Total Physical Memory _ 80%) _ 20%

-   DSS 시스템 : (Total Physical Memory _ 80%) _ 50%

이것은 일반적인 권고사항이며 대부분 Optimal시스템으로 수행되고 나머지 일부만 Onepass 소트 방식으로 수행되는 것을 목표로 삼아야 한다.

Multipass소트가 종종 발생하는 것으로 측정되면 크기를 늘리거나 튜닝이 필요한 것으로 받아들어야 하며, 이는 대용량 소트와 해시 조인이 많이 발생하는 DSS시스템에서도 마찬가지다.

## Sort Area 할당 및 해제

9i부터는 자동 PGA메모리 관리 방식이 도입되면서부터는 프로세스가 더 이상 사용하지 않는 공간을 즉각 반환함으로써 다른 프로세스가 사용할 수 있도록 한다.
