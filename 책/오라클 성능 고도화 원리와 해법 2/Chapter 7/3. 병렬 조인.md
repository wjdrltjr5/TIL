# 병렬 조인

병렬 조인 메커니즘을 이해하는 핵심 원리는 병렬 프로세스들이 서로 독립적으로 조인을 수행할 수 있도록 데이터를 분배하는 데에 있다.

분배작업이 완료되고 나면 프로세스 간에 서로 방해 받지 않고 각자 할당받은 범위 내에서 조인을 완료한다.

병렬 조인에는 크게 두 가지 방식이 있다.

-   파티션 방식 : Partition-Pair 끼리 조인 수행
-   Broadcast 방식 : 한쪽 테이블을 Broadcast하고나서 조인 수행 (파티셔닝 불필요)

1번 파티션 방식은 조인되는 두 테이블의 파티션 상태에따라 아래 세가지 경우로 나뉜다.

-   둘다 같은 기준으로 파티셔닝 된 경우
-   둘 중 하나만 파티셔닝된 경우(서로 기준이 달라도 여기에 해당)
-   둘다 파티셔닝되지 않은 경우

## 둘 다 같은 기준으로 파티셔닝 된 경우 - Full Partition Wise조인

두 테이블이 조인 컬럼에 대해 같은 기준으로 파티셔닝돼 있다면 병렬조인은 매우 간단하다.

PX PARTITION RANGE ALL 또는 PX PARTITION RANGE ITERATOR라고 표시되는 것을 통해 Full Partition Wise 조인인것을 확인할 수 있다.

-   다른 병렬 조인은 두 개의 서버집합이 필요한 반면 여기서는 하나의 서버집합만 필요하다.
-   Full Partition Wise 조인은 파티션 기반 Granule이므로 서버 프로세스 개수는 파티션 개수 이하로 제한된다.

-   파티션 방식은 어떤 것이든 상관없다. Range이든 리스트,해시이든 두 테이블이 조인컬럼에 대해 같은 방식, 같은 기준으로 파티셔닝 돼 있다면 서로 방해받지 않고 Partition Pair끼리 독립적인 병렬 조인이 가능하다.
-   조인 방시고 어떤 것이든 가능하다 NL조인, 소트머지조인, 해시조인등

## 둘 중 하나만 파티셔닝된 경우 - Partial Partition Wise조인

둘 중 한 테이블만 조인 컬럼에 대해 파티셔닝 된 경우 , 다른 한쪽 테이블을 같은 기준으로 동적으로 파티셩하고 나서

각 Partition-Pair를 독립적으로 병렬 조인한다. 둘다 파티셔닝되었지만 파티션 기준이 서로 다른 경우도 이 방식으로 조인될 수 있다.

중요한 것은 데이터를 동적으로 파티셔닝 하기 위해서는 데이터 재분배가 선행되어야 한다는 사실

즉 Inter-Operation Parallelism을 위해 두 개의 서버 집합이 필요해진다.

첫번째 서버집합이 하나의 테이블을 읽어 두 번째 서버집합에 데이터를 재분배하는 작업이 먼저 진행된다는 점만 다를뿐 2단계 조인과정은 Full Partition Wise조인과 100% 동일하다.

PARTITION (KEY) 또는 PART(KEY)라고 표시된것을 통해 Partial Partition Wise 조인인것을 확인할 수 있다.

## 둘다 파티셔닝되지 않은 경우 - 동적 파티셔닝

조인 컬럼에 대해 어느 한쪽도 파티셔닝되지 않은 상황이라면 오라클은 두 가지 방식중 하나를 사용한다.

-   양쪽 테이블을 동적으로 파티셔닝하고나서 Full Partition Wise조인
-   한쪽 테이블을 Broadcast하고나서 조인

동적으로 파티셔닝 과정

1. 첫번째 서버 집합이 한 테이블을 읽어 두번째 서버집합에 전송한다.

2. 첫번째 서버 집합이 다른 테이블을 읽어 두번째 서버집합에 전송한다.

1단계와 2단계를 처리하는 서버 집합은 서로 같은 존재다. 첫번째 서버집합은 데이터를 분배하는 역할을 하고 두 번째 서버집합은 받은 데이터를 파티셔닝하는 역할을 한다.

가능하다면 메모리 내에서 파티셔닝하겠지만 공간 부족하면 Temp 테이블 스페이스를 사용한다.

2단계까지 완료하고 나면 Partition-Pair가 구성되었으므로 Full Partition Wise조인을 수행할 수 있게 되었다.

3. 양 쪽 테이블 모두의 파티셔닝을 담당한 두 번째 서버집합이 각 Partition-Pair에 대해 독립적으로 병렬 조인을 수행한다.

이 방식의 특징은 조인을 본격적으로 수행하기 전 사전 정지 작업단계에서 메모리 자원과 Temp 테이블 스페이스 공간을 많이 사용한다는 데에 있다.

양쪽 모두 파티셔닝헤야 하므로 기본적으로 양쪽 테이블 모두에 대한 전체 범위처리가 불가피하다.

또한 조인 컬럼의 데이터 분포가 균일하지 않을 때는 프로세스간 일량 차이 때문에 병렬 처리 효과가 크게 반감될 수 있다.

이런 특징은 partition wise 조인에서도 똑같이 나타날 수 있지만 이런 컬럼이라면 에당초 파티션 기준 컬럼으로 부적당한 것이므로 병렬 비효율보다는 파티션 전략의 오류

결론적으로 동적 파티셔닝 방식은 아래와 같은 상황에서 유용한 병렬 조인 방식이다.

-   어느 한쪽도 조인 컬럼 기준으로 파티셔닝 되지 않은 상황에서
-   두 테이블 모두 대용량 테이블이고
-   조인 컬럼의 데이터 분포가 균일할때

## 둘다 파티셔닝 되지 않은 경우 - Broadcast방식

조인 컬럼에 대해 어느 한쪽도 파티셔닝 되지 않은 상황에서 오라클이 선택할 수 있는 두 번째 방식은 Broadcast 방식으로서

두 테이블 중 작은 쪽을 반대편 서버 집합의 모든 프로세스에 Broadcast하고나서 조인을 수행하는 방식

1. 1단계 첫번째 서버집합에 속한 프로세스들이 각자 읽은 한 테이블 레코드를 두번째 서버 집합에 속한 모든 병렬 프로세스에게 전송한다.

2. 2단계 두번째 서버집합에 속한 프로세스들이 각자 맡은 범위의 emp 테이블을 읽으면서 병렬로 조인을 수행한다. 1단계가 완료되면 두 번째 서버집합에 속한 프로세스 모두 한테이블의 완전한 집합을 갖게 되므로 프로세스간 상호간섭없이 독립적으로 조인 수행이 가능해진다.

양쪽테이블 모두 파티션 되지 않았을 때는 1차적으로 Broadcast방식이 고려되야 한다.

동적으로 파티셔닝 하는방식은 메모리자원과 Temp 테이블 스페이스 공간을 많이 사용하는 반면 이방식은 리소스 사용량이 매우 적기 때문이다.

이런 특징은 Broadcast되는 테이블이 아주 작을 때만 적용된다. 테이블이 중대형 이상일때는 과도한 프로세스 간 통신 때문에 성능이 매우 느려질 수 있다.

이외에도 Broadcast 방식이 갖는 특징을 정리하면 다음과 같다.

-   Broadcast는 작은 테이블임이 전제되어야 하므로 Serial 스캔으로 처리할 때도 많다 따라서 P->P이 아닌 S->P 형태가 오히려 일반적이고 이는 두 테이블 중 한쪽 테이블만 병렬로 처리함을 뜻한다.

-   Broadcast가 이루어지고 나서의 조인 방식은 어떤 것이든 선택 가능하다 NL조인, 소트머지조인, 해시조인등

-   Broadcast가 되는 작은 쪽 테이블은 전체범위처리가 불가피하지만 큰 테이블은 부분범위 처리가 가능하다.

## 4가지 병렬 조인 방식 특징 요약

-   Full Partition Wise 조인

    -   두 테이블 모두 조인컬럼에 대해 같은 기준으로 파티셔닝
    -   데이터 재분배 불필요 -> 단일 서버 집합만으로 수행

-   Partial Partition Wise조인

    -   둘 중 한 테이블만 조인 컬럼에 대해 파티셔닝된경우
    -   파티셔닝되지 않은 다른쪽 테이블을 같은 기준으로 파티셔닝하고나서 Full partition wise조인
    -   동적 파티셔닝을 위한 데이터 재분배 필요 -> 두개의 서버집합이 수행

-   동적 파티녀싱

    -   어느 한쪽도 조인 컬럼에 대해 파티셔닝 되지 않은 경우
    -   양쪽 테이블이 모두 대용량
    -   임시 테이블스페이스를 많이 사용
    -   양쪽 테이블 모두 전체 범위 처리
    -   조인 컬럼의 데이터 분포가 균일해야 함

-   Broadcast
    -   어느 한쪽도 조인 컬럼에 대해 파티셔닝 되지 않은 상황
    -   둘 중 하나의 테이블이 매우 작을 때
    -   동적 파티셔닝이 불필요 -> 큰 테이블에 대한 부분범위 처리 가능
