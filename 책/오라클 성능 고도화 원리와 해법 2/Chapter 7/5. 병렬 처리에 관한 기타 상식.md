# 병렬 처리에 관한 기타 상식

## Direct Path Read

병렬 방식으로 Full Scan할때는 버퍼 캐시를 커기지 않고 곧바로 PGA영역으로 읽어들이는 Direct Path Read방식을 사용한다.

## 병렬 DML

병렬 처리가 가능해지려면 쿼리, DML, DDL을 수행하기 전에 각각 아래와 같은 명령을 먼저 수행해 주어야 한다.

```
alter session enable parallel query (기본적으로 활성화)
alter session enable parallel dml
alter session enable parallel ddl (기본적으로 활성화)
```

병렬 DML을 수행할 때도 Exclusive모드 테이블 Lock이 걸린다는 사실

다른 트랜잭션이 해당 테이블에 DML을 수행하지 못하게 되므로 트랜잭션이 빈번한 주간에 이 옵션을 사용하는것은 금물이다.

## 병렬 인덱스 스캔

Index Fast Full Scan이 아닌 한 인덱스는 기본적으로 병렬로 스캔할 수 없다.

파티션된 인덱스일 때는 병렬 스캔이 가능하다. (파티션 기반 Granule)

## 병렬 NL조인

병렬 조인은 항상 Table Full Scan을 이용한 해시 조인 또는 소트 머지 조인으로 처리된다고 생각하지 쉽지만 인덱스 스캔을 기반으로 한 병렬 NL조인도 가능하다.
`(단 드라이빙 인덱스가 반드시 파티션 인덱스여야 한다.)`

### 병렬 NL조인의 효용성

-   Outer 테이블과 Inner 테이블이 둘다 초 대용량 테이블이다.
-   Outer 테이블에 사용된 특정 조건의 선택도가 매우 낮은데 그 컬럼에 대한 인덱스가 없다.
-   Inner 쪽 조인 컬럼에는 인덱스가 있다.
-   수행빈도가 낮다.

## 병렬 쿼리와 스칼라 서브쿼리

스칼라 서브쿼리를 기술하는 위치에따라 QC가 수행하기도 하고 병렬 서버가 수행하기도 한다.

병렬 처리 효과를 높이려면 부분범위 처리, 전체 범위 처리 여부에 따라 스칼라 서브쿼리 위치를 옮기거나 아예 일반 조인문으로 바꾸는 튜닝을 실시함으로써 큰 효과를 얻을 수 있다.

## 병렬 쿼리와 사용자 정의 함수

## 병렬 쿼리와 ROWNUM

SQL에 rownum을 포함하면 쿼리문을 병렬로 실행하는 데에 제약을 받게 되므로 주의해야 한다. QC가 담당하게 됨

## 병렬 처리 시 주의사항

언제 병렬 처리 기법을 사용하는것이 바람직한가?

-   동시 사용자 수고 적은 애플리케이션 환경 (야간 배치, DW, OLAP)에서 직렬로 처리할 때보다 성능 개선 효과가 확실할때

-   OLTP성 시스템 환경이더라도 작업을 빨리 완료함으로써 직렬로 처리할 때보다 오히려 전체적인 시스템 리소스 사용률을 감소시킬 수 있을 때

NL에서 해시 처럼 10분을 5분을 줄일려고 사용 X

다른 주의사항들

-   workarea_size_policy 를 manual 로 설정한다면, 사용자가 지정한 sort_area_size가 모든 병렬 서버에세 적용된다.

    -   따라서 sort_area_size를 크게 설정한 상태에서 지나치게 큰 병렬도를 지정하면 OS레벨에서 페이징이 발생하고 시스템을 마비시킬 수 있다.

-   병렬도를 지정하지 않으면 cpu_count \* parallel_threads_per_cpu만큼의 병렬 프로세스가 할당된다.

    -   adaptive multiuser기능을 사용하려는 경우가 아니라면 반드시 병렬도를 지정

-   실행계획에 P->P가 나타날 때면 지정한 병렬도의 2배수 만큼의 병렬 프로세스가 필요하다는 사실을 기억하자.

-   쿼리블록마다 병렬도를 다르게 지정한 경우 여러가지 우선 순위와 규칙에 따라 최종 병렬도가 결정된다.

    -   규칙을 위우기 보다는 병렬도를 같게 지정하자.

-   parallel 힌트를 사용할 때는 반드시 Full 힌트도 함께 사용하는 습관이 필요하다

    -   옵티마이저에 의해 인덱스 스캔이 선택될 경우 parallel 힌트가 무시되기 때문

-   parallel_index 힌트를 사용할 때는 반드시 index 또는 index_ffs 힌트를 함께 사용하는 습관이 필요하다.

    -   옵티마이저에 의해 Full Table Scan이 선택될 경우 힌트가 무시되기 때문

-   병렬 DML 수행히 Exclusive 모드 테이블 Lock이 걸리므로 업무 트랜잭션이 발생하는 주간에는 삼가야 한다.

-   테이블이나 인덱스를 빠르게 생성하려고 parallel 옵션을 사용했다면 작업을 완료하자마자 noparallel로 돌려놓는 것을 잊지 말자

-   부분범위처리 방식으로 조회하면서 병렬 쿼리를 사용한 때에는 필요한 만큼 데이터를 Fetch하고나서 곧바로 커서를 닫아주어야 한다.

Toad나 Orange처럼 부분범위 처리를 지원하는 쿼리 툴에서는 EOF도달하기 전까지 커서를 오픈한 채로 유지하기 때문에 병렬서버를 해제하지 못하고 대기 상태에 머물도록 한다.

이는 불필요한 리소스 낭비를 초래하므로 조회가 끝나자마자 select \* from dual같은 문장을 수행해 병렬 쿼리의 커서를 닫아주어야 한다.
