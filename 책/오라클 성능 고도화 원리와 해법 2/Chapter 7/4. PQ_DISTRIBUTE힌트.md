# PQ_DISTRIBUTE 힌트

4가지 병렬 조인 방식을 제어하기 위해 사용되는 pq_distribute힌트

## pq_distribute힌트의 용도

조인되는 양쪽 테이블의 파티션 구성, 데이터 크기에 등에 따라 병렬 조인을 수행하는 옵티마이저의 선택이 달라질 수 있다.

대게 옵티마이저의 선택이 최적이라고 할 수 있지만 가끔 그렇지 못한 경우가 있다.

-   옵티마이저가 파티션된 테이블을 적절히 활용하지 못하고 동적 재분할을 시도할때
-   기존 파티션 키를 무시하고 다른 키 값으로 동적 재분할 하고 싶을 때
-   통계정보가 부정확하거나 통계정보를 제공하기 어려운 상황에서 실행계획을 고정시키고자 할 때
-   기타 여러 가지 이유로 데이터 분배 방식을 변경하고자 할때

병렬 쿼리는 분할 정보 원리에 기초한다. 그 중에서도 병렬 조인을 위해서는 분배 조인 원리가 작동함을 이해하는 것이 매우 중요하다.

`이때 pq_distribute힌트는 조인에 앞서 데이터를 분배하는 과정에만 관여하는 힌트다`

```sql
select /*+ ordered use_merge(e) parallel(d 4) parallel(e 4) pq_distribute(e hash hash)
 */
from dept d, emp e
where e.deptno = d.deptno
```

위 쿼리는 분배만 해시방식으로 사용하지 조인은 소트머지 조인으로 수행한다.

### 구문 이해하기

pq_distribute(1,2,3);

-   1 : inner 테이블 명 또는 Alias
-   2 : outer테이블의 distribution 방식
-   3 : inner테이블의 distribution 방식

## 분배방식 지정

### pq_distribute(inner, none, none)

Full-Partition Wise 조인으로 유도할때 사용한다.

### pq_distribute(inner, partition, none)

Partial-Partition Wise조인으로 유도할 때 사용하며, Outer 테이블을 inner 테이블 파티션기준에 따라 파티셔닝하라는 뜻 당연히 inner 테이블이 조인키 컬럼에 대해 파티셔닝 돼 있을 때만 작동한다.

### pq_distribute(inner, none, partition)
Partial-Partition Wise 조인으로 유도할 때 사용하며, inner테이블을 Outer 테이블 기준에 따라 파티셔닝하라는 뜻. 당연히 outer 테이블이 조인 키 칼럼에 대해 파티셔닝 돼있을때만 작동한다.

### pq_distribute(inner, hash, hash)
조인 키 컬럼을 해시 함수에 적용하고 거기서 반환된 값을 기준으로 양쪽 테이블을 동적으로 파티셔닝 하라는 뜻

### pq_distribute(inner, broadcast, none)
outer 테이블을 broadcast 하라는 뜻
### pq_distribute(inner, none, broadcast)
inner 테이블을 broadcast 하라는 뜻
## pq_distribute 힌트를 이용한 튜닝 사례

통계정보가 없는 상태에서 병렬조인하면 옵티마이저가 아주 큰 테이블을 Broadcast하는 경우를 종종 보게 된다. 이럴때 사용

10g부터는 동적샘플링이 작동해 이런 경우가 낮지만 조인을 여러번 거치면 카디럴리티가 점점 부정확해지기 마련이다.
