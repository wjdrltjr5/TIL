# 문장수준 읽기 일관성

단일 SQL문이 수행되는 도중에 또는 트랜잭션 내에서 일련의 SQL문이 차례로 수행되는 도중에 다른 트랜잭션에 의해 데이터가 변경, 추가 삭제된다면 일관성 없는 결과집합을 리턴하거나 값을 잘못 갱신하는 문제가 발생할 수 있다.

이런 현상 방지를 위한 일관성을 보장하기 위해 DBMS마다 나름대로의 장치들을 마련하고 있다(트랜잭션 수준 읽기 일관성, 문장수준 읽기 일관성)

## 문장 수준 읽기 일관성

문장수준 읽기 일관성은 단일 SQL문이 수행되는 도중에 다른 트랜잭션에 의해 데이터의 추가, 변경, 삭제가 발생하더라도 일관성 있는 결과집합을 리턴하는 것을 말한다.

변경이 진행 중인 값 즉 아직 커밋되지 않은 값을 다른 트랜잭션이 읽도록 Dirty Read를 허용한다면 읽기 일관성이 보장되지 않는다.

오라클을 제외한 다른 DBMS는 로우 Lock을 사용해 Dirty Read를 방지한다.

읽기 작업에 Shared Lock을 사용함으로써, Exclusive Lock이 걸린 로우를 읽기 못하도록 한다.

하지만 테이블 단위 Lock을 사용하지 않는한 Dirty Read를 방지하는 것만드로는 문장수준 읽기 일관성이 완벽하게 보장되지 않는다.

오라클은 Shared Lock을 사용하지 않고 Undo세그먼트에 저장해 둔 Undo 데이터를 활용하므로 그런 조치 없어도 완벽한 문장수준 읽기 일관성을 보장한다.

## Consistent 모드 블록 읽기

오라클은 쿼리가 시작된 시점을 기준으로 데이터를 읽어 들인다. 쿼리가 시작되기 전에 이미 커밋된 데이터만 읽고, 쿼리 시작 이후에 커밋된 변경사항을 읽어들이지 않는다.

변경이 발생한 블록을 읽을 때는 현재의 Current 블록으로부터 CR블록을 생성해서 쿼리가 시작된 시점으로 되돌린 후 그것을 읽는다.

`Current 블록은 디스크로부터 읽혀진 후 사용자의 갱신사항이 반영된 최종 상태의 원본 블록`을 말하며

`CR 블록은 Current 블록에 대한 복사본이다.` CR블록은 여러 버전이 존재할 수 있지만 Current 블록은 오직 한 개 뿐

Current 블록을 CR Copy 블록으로 복사해 읽기 일관성을 지원하는 메커니즘을 버전 읽기 일관성 모델(Multi-Version Read Consistency Model) 이라고 한다.

쿼리가 시작된 시점을 기준으로 데이터를 읽는 것을 Consistent모드 읽기

데이터를 찾아가 그시점의 최종 값을 읽는 것을 Current 모드 읽기라고 한다.

오라클은 SCN(System Commit Number)이라고 하는 시간정보를 이용하 데이터베이스의 일관성 있는 상태를 식별한다. (시스템 전체적으로 공유되는 글로벌 변수)

SCN은 커밋이 없더라도 오라클 백그라운드 프로세스에 의해 조금씩 증가한다. SCN은 읽기 일관성과 동시성 제어를 위해 사용되고

생성된 Redo 로그 정보의 순서를 식별하는데에도 사용되며, 마지막으로 데이터 복구를 위해서도 사용된다.

Consistent 모드 읽기를 이해하기 위해 알아야 할 또 한가지 개념은 블록 SCN이다.

오라클은 변경시점 확인을 위해 블록 헤더에도 블록 SCN(System Change Number)정보를 관리한다.

## Consistent 모드 블록 읽기의 세부 원리

오라클에서 수행되는 모든 쿼리는 Global 변수인 SCN(System Commit Number)값을 먼저 확인하고 나서 읽기 작업을 시작하는데, 이를 쿼리 SCN 또는 스냅샷 SCN이라고 한다.

쿼리 SCN을 들도 다니면서 읽는 블록마다 블록 SCN과 비교해 읽을 수 있는 버전인지를 판단하는 것

쿼리 SCN 버전보다 블록 SCN 버전이 낮다면 그냥 읽고 committed상태인 블록 SCN이 쿼리 SCN보다 크다면 카피하고 undo처리한 CR블록을 만들어서 읽는다.
