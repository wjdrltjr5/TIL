# Statspack / AWR

v$sysstat 과 v$system_event를 주기적으로 수집해 성능관리에 활용하는 사례처럼 AWR(Automatic Workload Repository)도 같은 원리를 적용해 표준화된 방식으로 성능관리를 지원하려고 오라클이 제공하는 패키지다.

이들 패키지는 Ratio 기반 성능 진단과 Wait Event 기반 성능 진단 방법론을 둘 다 가지고 있다.

아래 나열한 동적 성능 뷰(Dynamic Performance View)를 주기적으로 특정 Repository에 저장하고 , 이를 분석해 오라클 데이터베이스 전반의 건강 상태를 체크하고 병목 원인과 튜닝 대상을 식별해 내는 데 사용한다.

-   v$segstat
-   v$undostat
-   v$latch
-   v$latch_children
-   v$sgastat
-   v$pgastat
-   v$sysstat
-   v$system_event
-   v$waitstat
-   v$sql
-   v$sql_plan
-   v$sqlstats
-   v$active_session_history
-   v$osstat
-   기타등등

Statspack과 AWR은 거의 같은 내용을 담고 있으며 다른점은 정보를 수집하는 방식에 있다.

Statspack 은 SQL을 이용한 딕셔너리 조회 방식인데 반해 AWR은 DMA(Direct Memory Accaess)방식으로 SGA를 직접 액세스하기 때문에 좀더 빠르게 정보를 수집할 수 있다.

부하가 적기 때문에 AWR은 Statspack보다 더 많은 정보를 수직하보 제공할 수 있게 되었다.

## Statspack / AWR 기본 사용법

Statspack에서는 PERFSTAT 계정 밑에 stats$로 시작하는 뷰를 통해 수집된 성능 정보들을 조회한다.

AWR에서는 SYS 계정 밑에 dba*hist*로 시작하는 뷰를 이용한다.

이블 듀를 이용해 성능 분석자료를 보고서 형태로 뽑아 볼 수 있는데, 직접 작성한 쿼리를 이용할 수도 있지만 아래 스크립트를 이용하면 표준화된 보고서를 출력해준다.

> @?/rdbms/admin/awrrpt

> @?/rdbms/admin/spreport

성능 진단 보고서를 출력할 때는 측정 구간 즉 시작 스냅샷 ID와 종료 스냅샷 ID를 어떻게 입력하느냐가 가장 중요하다.

만약 매일매일 시스템의 Load Profile이 어떻게 변하는지 비교할 목적이라면 09~18시까지 하루 업무 시간 기준으로 뽑아도 상관없다.
(어느요일에 SQL 수행과 트랜잭션이 가장 많은지 어느 요일에 I/O가 가장 많이 발생하는지 등을 비교)

하지만 문제점을 찾아 성능을 해결할 목적이라면 peak 시간대 또는 장애가 발생한 시점을 전후해 가능한 한 짧은 구간을 선택해야 한다.

## Statspack / AWR 리포트 분석

AWR뷰를 잘 활용하면 상용 모니터링 툴 도움 없이도 누구나 다양한 성능 진단 보고설르 만들어 낼 수 있다.

Statspack과 AWR 리포트에도 맨 첫장을 보면 오라클 데이터베이스의 요약보고서가 나온다. 그 한장의 보고서를 정확히 해석할 수 있다면 AWR을 효과적으로 활용할 수 있다.

## Load Profile

| 항목            | Per Second | Per Transaction |
| --------------- | ---------- | --------------- |
| Redo size       | 140,839.60 | 5,345.24        |
| Logical reads   | 47,768.26  | 1,812.93        |
| Block changes   | 711.34     | 27.00           |
| Physical reads  | 736.69     | 27.96           |
| Physical writes | 84.69      | 3.21            |
| User calls      | 2,401.63   | 91.15           |
| Parses          | 412.66     | 15.66           |
| Hard parses     | 1.49       | 0.06            |
| Sorts           | 138.94     | 5.27            |
| Logons          | 0.79       | 0.03            |
| Executes        | 1,187.18   | 45.06           |
| Transactions    | 26.35      | -               |

Per Second는 각 측정 지표 값들을 측정시간으로 나눈것이다. 따라서 초당 부하 발생량을 의미

Per Transaction은 각 측정 지표 값들을 트랜잭션 개수로 나눈것이다. 한 트랜잭션 내에서 평균적으로 얼만큼의 부하가 발생하는지를 나타낸다.

사실 트랜잭션 개수가 commit 또는 rollback 수행횟수를 단수히 더한값이어여 의미없는 수치로 받아들여질 때가 종종 있다.

AWR에서 보여지는 위 항목들은 dba_hist_sysstat 뷰에서 얻을 결과이므로 각각 어떤 통계항목을 조회했는지를 안다면 의미를 어렵지 않게 이해할 수 있다.

215p~
