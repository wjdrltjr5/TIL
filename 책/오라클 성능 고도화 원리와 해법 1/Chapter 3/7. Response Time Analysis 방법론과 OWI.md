# Response Time Analysis 방법론과 OWI

앞서 본것처럼 대기 이벤트를 기반으로 세션 또는 시스템 전체에 발생하는 병목 현상과 그 원인을 찾아 문제를 해결하는 방법 과정을 대기 이벤트 기반 또는 Response Time Analysis 성능관리 방법론이라고 한다.

```
Response TIme = Service Time + Wait Time
              = CPU Time + Queue Time
```

이 보고서는 오라클 서버의 응답 시간을 서비스 시간과 대기 시간의 합으로 정의하고 있다.

서비스 시간은 프로세스가 정상적으로 동작하며 일을 수행한 시간을 말한다. CPU Time와 같은의미

대기 시간은 대기 이벤트가 발생해 수행을 잠시 멈추고 대기한 시간을 말한다. 다른말로 Queue Time이라고 한다.

Response Time을 위와 같이 정의하고 CPU Time과 Wait time을 각각 break down 하면서 서버의 일량과 대기시간을 분석해 나간다.

CPU Time은 파싱 작업에 소요된 시간인지 아니면 쿼리 본연의 오퍼레이션 수행을 위해 소요된 시간인지를 분석한다.

Wait time은 각각 발생한 대기 이벤트들을 분석해 가장 시간을 많이 빼앗긴 이벤트 중심으로 해결방안을 모색한다.

OWI(오라클 공식 용어 아님)는 Response Time Analysis방법론을 지원하려고 오라클이 제공하는 기능과 인터페이스를 통칭하는 말로 Oracle Wait Interface의 줄인말

`Response Time Analysis 방법론에 기반한 튜닝은 병목해소 과정`이라고 요약할 수 있다.

```sql
/* 쿼리를 수행하는 20개 프로세스가 동시에 떠서 작업을 수행중이라고 가정

하루 저녁에 1억 건을 처리해야 하는 배치 프로그램이어서 속도를 향상시키기 위해 서로 읽는 범위를 달리 하여 Parallel방식으로 수행되게 설정*/

insert into t1
select /*+ ordered use_nl(t3) */
       seq.nextval
     , t2.*
     , t3.*
  from t2
     , t3
 where t2.key = t3.key
   and t2.col between :range1 and :range2;
```

20개를 동시에 수행시켰는데도 속도가 나지 않아 이벤트 분석을 진행

db file scattered read 대기 이벤트가 Wait time의 대부분을 차지하고 있었다.

이 이벤트의 발생 원인은 Table Full Scan 분석결과 t2테이블 기준으로 NL조인을 수행하면서 반복 액세스가 일어나는 T3테이블 조인 컬럼이 인덱스가 없어 매번 Table Full Scan으로 처리되고 있었다.

인덱스를 추가하여 정상적인 Index Scan으로 처리되도록 튜닝

그후 buffer busy wait과 latch: cache buffers chains 이벤트가 새롭게 발생

앞에서는 디스크I/O 때문에 서버 프로세스의 처리 속도가 느렸는데 많은 처리를 버퍼 캐시 내에서 할 수 있게 됨으로써 서버프로세스의 처리 속도가 향상

그로 인해 버퍼 블록에 대한 동시 액세스가 증가하게 되면서 메모리 경합이 발생

캐싱된 버퍼 블록에 대한 읽기 요청이 많아 생기는 문제이므로 블록 요청 횟수를 줄여야 한다 NL조인을 해시 조인방식으로 변경(해시 조인은 SGA가 아닌 PGA영역을 사용하니까 )

이제 버퍼 캐시에서 발생하던 경합이 해소됨으로 인해 또 다른 문제가 발생하였다.

select경합이 해소되 이번에는 insert 처리 부분에서 경합이 발생

insert에 의한 Redo 레코드 생성 속도가 증기하니까 Redo 로그 버퍼 공간이 부족할 때 발생하는 log buffer space 대기 이벤트가 발생

또한 Sequence 테이블에 대한 경합으로 end: SQ - contention까지 발생하기 시작

내재돼있던 문제들이 앞에서 처리속도가 개선되면서 속속 드러나고 있는것

Redo 로그 버퍼의 크기를 약간 늘려주고 Sequence 캐시 사이즈를 10에서 20으로 늘려주었다.

이처럼 OWI 기반 튜닝은 모니터링과 튜닝을 반복하면서 병목을 해소해 나가는 방법론이다
