# Prefetch

Prefetch라는 용어는 오라클에서 여러 가지 의미로 쓰인다.

Row Prefetch : 한번의 Fetch Call로 Array크기만큼 여러 개 레코드를 가져오는 것

이번 장에서는 테이블 Prefetch , 인덱스 Prefetch지칭

오라클을 포함한 모든 DBMS는 디스크 블록을 읽을 때 곧이어 읽을 가능성이 높은 블록을 미리 읽어오는 Prefetch 기능을 제공한다.

디스크 I/O가 비용이 크기 때문에 한번의 I/O Call을 통해 다량의 블록을 퍼 올릴 수 있다면 그만큼 성능향상에 도움이 되기 때문

Multiblock I/O도 Prefetch 기능 중 하나

Prefetch는 한번에 여러 개 Single Block I/O를 동시 수행하는 것을 말한다.

앞에서 설명한 Multi Block I/O는 한번의 I/O Call로써 서로 인접한 블록들을 같이 읽어 적재하는 것

테이블 Prefetch와 인덱스 Prefetch는 인접하지 않은 블록, 즉 서로 다른 익스텐트에 위치한 블록을 배치방식으로 미리 적재하는 것

이 기능은 곧 읽을 가능성이 높은 블록들을 미리 적재했을 때만 성능 향상에 도움을 준다.

미리 적재했는데 실재 사용으로 연결되지 못하면 버퍼 캐시 효율만 나빠진다. 오라클은 미리 적재했을 때 효과를 얻을 수 있는 오퍼레이션에만 이 기능을 적용하지만, 그럼에도 Prefetch한 블록들이 실제 액세스로 연결되지 못한 채 캐시에서 밀려나는 비율이 높다면 더는 이 기능이 작동되지 못하도록 정지 시킨다.

Prefetch된 블록들을 모니터링 하는 기능은CKPT 프로세스가 맡는다.

앞으로 읽어야 할 블록들을 미리 적재하는 기능이므로 시스템 전반의 디스크 경합을 줄여주기보다. I/O를 위한 시스템 Call을 줄이고 개별 쿼리의 수행 속도를 향상시키는데 주로 도움을 준다.

## 인덱스 Prefetch

Sequential 액세스 성능을 향상시키려고 Multiblock I/O와 인덱스 Prefetch같은 기능을 사용한다.

인덱스 Prefetch 기능이 가장 효과적일 수 있는 상황은 Index Full Scan이 일어날 때다. 부분범위처리 방식으로 중간에 멈추지만 않는다면 모든 인덱스 리프 블록 읽게 되기 때문

## 테이블 Prefetch

테이블 Lookup Prefetch 또는 데이터 블록 Prefetch라고도 한다. 인덱스를 경유해 테이블 레코드를 액세스 하는 도중 디스크에서 캐시로 블록을 적재해야 하는 상황이 발생할 수 있는데 그때 다른 테이블 블록까지 미리 적재해 두는 기능

리프블록에 있는 인덱스 레코드는 논리적인 순서를 따라 읽는다 읽는 도중에 디스크 I/O가 필요해지면 현재 읽던 리프 블록 내에서 앞으로 액세스해야 할 테이블 블록 주소 목록을 미리 취합할 수있다.

Random액세스 성능을 향상시키려고 버퍼 Pinning과 테이블 Prefetch 같은 기능을 사용한다.

버퍼 Pinning은 Random 액세스에 의한 논리적 블록 요청 횟수를 감소시키고, 테이블 Prefetch는 디스크 I/O에 의한 대기 횟수를 감소시킨다.

인덱스 클러스터링 팩터가 나쁠 때 특히 효과를 발휘한다. 클러스터링 팩터가 나쁘면 논리적 I/O가 증가할 뿐 아니라 디스크 I/O도 많이 발생하기 때문

오라클에서 클러스터링 팩터가 높은 인덱스를 이용할 때 테이블 Random 액세스를 최소화할 수 있다고 했는데 그 원리를 이용한 액세스 방식

인덱스에서 읽은 집합을 실시간으로 정렬해 클러스터링 팩터를 좋게 만든 상태에서 테이블을 액세스 하는 것으로 이해하면 된다.

한 번 액세스해 그곳에 저장된 레코드를 모두 읽어들이므로 Random액세스의 비효율을 완전히 제거할 수 있다.
