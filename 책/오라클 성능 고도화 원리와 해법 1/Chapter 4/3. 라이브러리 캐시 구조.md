# 라이브러리 캐시 구조

라이브러리 캐시는 Shared Pool 내에 위치하며, SQL 공유 커서 및 데이터베이스 오브젝트에 대한 정보를 관리한다. 그리고 여기에 저장되는 정보의 단위를 라이브러리 캐시 오브젝트라고부른다.

SQL 커서 뿐 아니라 컴파일을 거친 프로시저, 함수, 패키지, 트리거 등 PL/SQL 프로그램을 담는 PL/SQL Area도 라이브러리 캐시에 저장한다.

실행가능 LCO : SQL 커서, PL/SQL 오브젝트처럼 실행 가능한 오브젝트

오브젝트 LCO : 테이블, 인덱스, 클러스터같은 데이터베이스 오브젝트 정보

스키마 오브젝트는 데이터 딕셔너리 캐시에도 캐싱돼 있는데 이를 읽어 라이브러리 캐시에 중복저장하는 이유는 LCO간 의존성을 관리하기 위한 목적

LCO 각각에는 자신을 참조하는 다른 실행가능 LCO목록을 갖는다.

라이브러리 캐시에 캐싱되는 정보를 또 다른 측면에서 두 가지로 나누어 볼수 있다.

-   생성후 DROP하기 전까지 데이터베이스에 영구적으로 보관되는 오브젝트 정보 (테이블, 인덱스, 클러스터, 뷰, 트리거, 패키지, 사용자 정의 함수/프로시저가 여기 포함)

-   실행시점에 생성돼서 인스턴스가 떠있는 동안에만 존재하는 일시적인 오브젝트 정보 ( 커서와 Anonymous PL/SQL이 대표적)
    -   이들은 이름을 따로 지정하지 않으며 문장을 구성하는 전체 문자열 그대로가 이름 역할 (SQL문장이 같아야 하는이유 바인드변수랑 컨벤션으로 맞춰야 하는 이유 커서)

라이브러리 캐시는 데이터 딕셔너리 캐시와 함께 Shared Pool에 할당된 메모리 공간을 사용한다.

Shared Pool도 DB 버퍼 캐시처럼 LRU 알고리즘에 의해 관리되며, 재사용 빈도가 낮은 SQL은 캐시에서 밀어냄으로써 새로운 SQL을 캐싱할 수 있도록 공간을 확보한다.

Shared Pool에서 특정 오브젝트 정보 또는 SQL 커서를 위한 Free Chunk를 할당받으려 할때 필요한 래치카 shared pool 래치다.

라이브러리 캐시도 DB 버퍼 캐시처럼 해시구조로 관리된다 해시 버킷에 LCO 핸들이 체인으로 연결돼 있고, 핸들을 통해 LCO 힙을 찾아가는 주고

DB 버퍼 캐시와 마찬가지로 해시 함수를 통해 리턴된 해시 값을 가지고 해시 버킷을 할당한다.

커서는 Parent Cursor 밑에 Child 커서가 연결되는 구조를 갖는다. SQL문장이 100% 동일한데도 커서를 공유하지 못하고 커서를 별도로 생성해야 할 때가 있는데 오라클은 그럴 때 다중 Child 커서를 사용한다.

DB 버퍼캐시에서 체인에 연결된 리스트 구조를 보호하기 위해 cache buffers chains 래치를 사용하는 것처럼

라이브러리 캐시 체인을 탐색하고 변경하려면 먼저 library cache 래치를 획득해야 한다.

이에 대한 경합이 발생할때 latch : library cache 대기 이벤트가 발생한다.
래치 개수도 몇개에 불과하므로 하드파싱은 물론 소프트 파싱이 많이 발생해도 래치에 대한 경합이 증가한다.

DB버퍼 캐시에서 버퍼 자체를 보호하기위해 버퍼 Lock을 사용한 것처럼 LCO를 보호하기 위해 라이브러리 캐시 Lock과 라이브러리 캐시 Pin을 사용한다.

LCO에 접근할 때는 먼저 핸들에 대한 Lock을 획득해야 한다. 그리고 나서 LCO에 실제 내용이 담긴 힙에서 정보를 읽거나 변경할 때는 Pin을 걸어 두어야 한다.

그럼으로써 LCO를 읽고, 쓰고, 실행하는 동안 다른 프로세스에 의해 정보가 변경되거나 캐시에서 밀려나는 것을 방지한다.

shared pool 래치와 library cache 래치 경합은 소프트/하드 파싱을 동시에 심하게 일으킬때 발생하기

library cache lock과 library cache pin 대기이벤트는 주로 SQL 수행도중 DDL을 날릴 때 발생한다.

트랜잭션이 활발한 시간대에 DDL문을 날려 오브젝트 정의를 변경하면 라이브러리 캐시에 심한 부하를 유발한다.

`라이브러리 캐시 최적화를 위한 개발 측면에서의 노력은 아래 3가지로 요약할 수 있다.`

-   `커서를 공유할 수 있는 형태로 작성 : 바인드 변수 및 컨벤션대로 작성하기 (하드파싱 방지)`

-   `세션 커서 캐싱 기능을 이용해 라이브러리 캐시에서 SQL 찾는 비용 줄이기 `

-   `애플리케이션 커서 캐싱을 이용해 Parse Call발생량을 줄인다.`
