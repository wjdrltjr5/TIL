# 운영체제 사례

## 4.7.1 Widows 스레드

Windows 응용들은 프로세스 형태로 실행되며 이들 각 프로세스는 한 개 또는 그 이상의 스레드를 가질 수 있다.

Windows에서 기술한 일대일 대응을 사용하며 사용자 수준 스레드 하나마다 커널 스레드 하나가 대응된다.

-   각 스레드를 유일하게 지목하는 스레드 ID
-   처리기의 상태를 나타내는 레지스터 집합
-   프로그램 카운터
-   사용자 모드에서 실행될 때 필요한 사용자 스택, 커널 모드에서 실행될 때 필요한 커널 스택
-   실행시간 라이브러리와 동적 링크 라이브러리(DLL) 등이 사용하는 개벌 데이터 저장 영역

레지스트 집합, 스택, 개별 데이터 저장 영역들은 그 스레드의 문맥으로 불린다.
스레드의 주요 자료구조

-   ETHREAD : 실행 스레드 블룩

    -   그 스레드가 속판 프로세스를 가리키는 포인터
    -   스레드가 실행을 시작해야 할 루틴의 주소
    -   KTHREAD에 대한 포인터

-   KTHREAD : 커널 스레드 블록

    -   스레드의 스케줄링 및 동기화 정보
    -   커널 모드에서 실행될 때 사용되는 커널 스택과 TEB에 대한 포인터

-   TEB : 스레드 환경 블록
    -   사용자 모드에서 실핼될 때 접근되는 사용자 공간 자료구조
    -   스레드 식별자
    -   사용자 스택
    -   스레드 국지 저장소 정보를 가지고 있음

ETHREAD, KTHREAD 모두 커널 안에 존재한다. 이는 커널만이 이들을 접근할 수 있다는 것을 의미한다.

## 4.7.2 Linux 스레드

프로세스를 복제하는 기능을 가진 fork() 시스템 콜을 제공한다. Linux는 clean() 시스템 콜을 이용하여 스레드를 생성할 수 있는 기능도 제공한다.

그러나 Linux는 프로세스와 스레드를 구별하지 않는다. 프로그램 내의 제어 흐름을 나타내기 위하여 프로세스나 스레드보다 태스크라는 용어를 사용한다.

clone()이 호출될 때 부모와 자식 태스크가 자료구조를 얼마나 공유할지 결정하는 플래그의 집합이 전달된다.

| 플래그 이름   | 의미                         |
| ------------- | ---------------------------- |
| CLONE_FS      | 파일 시스템 정보가 공유된다. |
| CLONE_VM      | 같은 메모리 공간이 공유된다. |
| CLONE_SIGHAND | 신호 처리기가 공유된다.      |
| CLONE_FILES   | 열린 파일의 집합이 공유된다. |

위에 해당하는 모든 플래그를 전달 받았다고 했을 때 부모 태스크와 자식 태스크는 같은 파일 시스템 정보, 같은 메모리 공간, 같은 신호처리기, 같은 열린 파일의 집합을 공유하게 된다.

이런한 식으로 clone()을 사용하는 것은 부모 태스크가 자식 태스크와 거의 모든 자원을 공유하기 때문에 스레드를 생성하는 것과 같은 결과가된다

그러나 아무 플래그 없이 clone()이 호출되면 공유는 일어나지 않게 되고 fork()시스템 콜이 제공하는 기능과 유사한 기능성을 제공한다.

Linux 커널이 태스크를 표현하는 방식 때문에 다양한 공유 수준이 가능하다. 시스템은 태스크마다 고유한 커널 자료구조가 존재한다. 이 자료구조는 태스크의 데이터를 저장하는 것이 아니라 데이터가 저장된 다른 자료구조를 가리키는 포인터를 포함한다.

다른 자료구조에는 열린 파일의 리스트를 나타내는 자료구조, 신호 처리 정보 및 가상 메모리 등이 있다. fork()가 호출되면 부모 프로세스의 관련된 자료구조를 복사함으로써 새로운 태스크를 생성한다.

clone()시스템 콜을 호출하여 새로운 태스크를 생성할 수도 있다. 그러나 모든 데이터를 복사하는 것이 아니라 전달된 플래그에 따라 부모 태스크의 자료구조를 가리키게 된다.

clone() 시스템 콜의 융통성은 컨테이너 개념으로 확장될 수 있다. Linux 커널아래 서로 격리되어 실행되는 여러 개의 Linux 컨테이너를 생성하는 것을 가능하게 한다.

Linux 컨테이너를 생성하도록 clone()에 전달할 수 있는 플래스가 있다.
