# 프로세스 스케줄링

다중 프로그래밍의 목적은 CPU 이용을 최대화하기 위하여 항상 어떤 프로세스가 실행되도록 하는 데 있다

시분할의 목적은 각 프로그램이 실행되는 동안 사용자가 상호 작용할 수 있도록 프로세스들 사이에서 CPU 코어를 빈번하게 교체하는 것

이 목적을 달성하기 위해 `프로세스 스케줄러`는 코어에서 실행 가능한 여러 프로세스 중에서 하나의 프로세스를 선택할 수 있다.

각 CPU 코어는 한 번에 하나의 프로세스를 실행할 수 있다. 다중 코어 시스템은 한 번에 여러 프로세스를 실행할 수 있다.

코어보다 많은 프로세스가 있는 경우 초과분은 코어가 사용 가능해지고 나서 다시 스케줄 될 때까지 기다려야 한다.

현재 메모리에 있는 프로세스 수를 `다중 프로그래밍 정도`라고 한다. 다중 프로그램 몇 시간 공유의 목표를 균형 있게 유지하려면 프로세스의 일반적인 동작을 고려 해야 한다.

일반적으로 대부분의 프로세스는 I/O 바운드 또는 CPU 바운드로 설명할 수 있다.

`I/O 바운드 프로세스`는 계산에 소비하는 것보다 I/O에 더 많은 시간을 소비하는 프로세스이다.

`CPU 바운드 프로세스`는 계산에 더 많은 시간을 사용하여 I/O 요청을 자주 생성하지 않는다.

## 3.2.1 스케줄링 큐

프로세스가 시스템에 들어가면 `준비 큐`에 들어가서 준비 상태가 되어 CPU 코어에서 실행되기를 기다린다.

이 큐는 일반적으로 연결 리스트로 저장된다. 큐 헤더에는 리스트의 첫 번째 PCB에 대한 포인터가 저장된고 PCB에는 준비 큐의 다음 PCB를 가리키는 포인터 필드가 존재한다

시스템에는 다른 큐도 존재한다. 프로세스에 CPU 코어가 할당되면 프로세스는 잠시 동안 실행되어 결국 종료되거나 인터럽트 되거나 I/O 요청의 완료와 같은 특정 이벤트가 발생할 때까지 기다린다. 이런 프로세스를 `대기 큐`에 삽입된다.

프로세스 스케줄링의 일반적인 표현은 `큐잉 다이어그램`이다.

새 프로세스는 처음에 준비 큐에 놓인다. 프로세스는 실행을위해 선택되거나 또는 `디스패치`될 때까지 기다린다. 프로세스에 CPU 코어가 할당되고 실행 상태가 되면, 여러 이벤트 중 하나가 발생할 수 있다.

-   프로세스가 I/O 요청을 공표한 다음 I/O 대기 큐에 놓일 수 있다
-   프로세스는 새 자식 프로세스를 만든 다음 자식의 종료를 기다리는 동안 대기 큐에 놓일 수 있다.
-   인터럽트 또는 타임 슬라이스가 만료되어 프로세스가 코어에서 강제로 제거되어 준비 큐로 돌아갈 수 있다

처음 두 경우에는 프로세스가 결국 대기 상태에서 준비 상태로 전환된 다음 준비 큐에 다시 들어간다.

프로세스는 종료할 때까지 이 주기를 계속한다. 종류 시점에 모든 큐에서 제거되고 PCB 및 자원이 반환된다.

## 3.2.2 CPU 스케줄링

`CPU 스케줄러`의 역할은 준비 큐에 있는 프로세스 중에서 선택된 하나의 프로세스에 CPU코어를 할당할는 것

CPU 스케줄러는 CPU를 할당하기 위한 새 프로세스를 자주 선택해야 한다. I/O 바운드 프로세스는 I/O요청을 대기하기 전에 몇 밀리초 동안만 실행할 수 있다.

CPU 바운드 프로세스에는 오랜 시간 동안 CPU 코어가 필요하지만 스케줄러는 프로세스에게 코어를 장기간 부여할 가능성이 없다.

프로세스에서 CPU를 강제로 제거하고 실행될 다른 프로세스를 스케줄 하도록 설계될 가능성이 높다. 따라서 CPu 스케줄러는 일반적으로 훨씬 더 자주 실행되지만 적어도 100밀리초마다 한번씩 실행된다.

일부 운영체제는 `스와핑`으로 알려진 중간 형태의 스케줄링을 가지고 있는데, 핵심 아이디어는 때로는 메모리 (및 CPU에 대한 능동적 경쟁) 프로세스를 제거하여 다중 프로그래밍의 정도를 감소시키는 것이 유리할 수 있다는 것

나중에 프로세스를 메모리에 다시 적재될 수 있으며 중단된 위치에서 실행을 계속할 수 있다.

`프로세스는 메모리에서 디스크로 스왑아웃하고 현재 상태를 저장하고, 이후 디스크에서 메모리로 스왑인하여 상태를 복원할 수 있기 떄문에 이 기법을 스와핑이라고 한다.`

스와핑은 일반적으로 메모리가 초과 사용되어 가용공간을 확보해야 할 때만 필요하다.

## 3.2.3 문맥교환 (Context Switch)

인터럽트는 운영체제 CPU 코어를 현재 작업에서 뺏어내어 커널 루틴을 실행할 수 있게 한다.

`이러한 연산은 범용 시스템에서는 자주 발생한다. 인터럽트가 발생하면 시스템은 인터럽트 처리가 끝난 후에 문맥을 복구할 수 있도록 현재 실행중인 프로세스의 현재 문맥을 저장한다.`

문맥은 프로세스의 PCB에 표현된다. 문맥은 CPU 레지스터의 값, 프로세스의 상태, 메모리 관리 정보 등을 포함한다.

`일반적으로 커널모드이건 사용자 모드이건 CPU의 현재 상태를 저장하는 작업을 수행하고 (state save) 나중에 연산을 재개하기 위하여 상태 복구 작업을 수행(state restore)한다.`

이러한 작업을 `문맥 교환 (Context switch)`이라고 한다. 문맥 교환이 일어나면 커널은 과거 프로세스의 문맥을 PCB에 저장하고 실행이 스케줄된 새로운 프로세스의 저장된 문맥을 복구한다.

`문맥 교환이 진행될 동안 시스템이 아무런 유용한 일을 못 하기 때문에 문맥 교환 시간은 순수한 오버헤드이다.`

문맥교환시간은 하드웨어의 지원에 크게 좌우된다.
