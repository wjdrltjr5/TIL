# 운영체제 디버깅

넓게는 디버깅은 하드웨어와 소프트웨어에서의 시스템의 오류를 발견하고 수정하는 행위이다.

성능 문제는 버그로 간주되므로 시스템에서 처리 중에 발생하는 병목현상을 제거하여 성능을 향상시키려는 성능 조정도 디버깅에 포함된다.

## 2.10.1 장애 분석

프로세스가 실패한다면, 운영체제 대부분은 시스템 관리자 또는 문제를 발생시킨 사용자게에 문제를 발생했다는 것을 경고하기 위해 오류 정보를 로그파일에 기록한다.

또한 프로세스가 사용하던 메모리를 캡처한 `코어 덤프`를 취하고 차후 분석을 위해 파일로 저장한다. (초창기 시절 메모리를 코어라고 부름)

실행중인 프로그램과 코어 덤프는 디버거에 의해 검사될 수 있으며, 장애 발생시 프로그래머가 프로세스의 코드와 메모리를 분석할 수 있도록 한다.

커널 장애는 `크래쉬`라고 불린다. 프로세스 장애와 마찬가지로 오류 정보가 로그파일에 저장되고 메모리의 상태가 `크래쉬 덤프`에 저장된다.

## 2.10.2 성능 관찰 및 조정

병목지점을 발견하기 위하여 시스템 성능을 감시할 수 있다. 도구는 프로세스별 또는 시스템 전체의 관찰을 제공하느냐로 특징이 묘사될 수 있다. 이러한 관찰을 위해 도구는 카운터 또는 추적의 두가지 접근 방식 중 하나를 사용할 수 있다.

### 2.10.2.1 카운터

운영체제는 일련의 카운터를 통해 호출된 시스템 콜 횟수 또는 네트워크 장치 또는 디스크에 수행된 작업 수와 같은 시스템 활동을 추적한다.

카운터를 사용하는 Linux의 예

-   프로세스별

    -   ps : 하나의 프로세스 또는 선택된 프로세스에 대한 정보를 보고한다.
    -   top : 현재 프로세스에 대한 실시칸 통계를 보고한다.

-   시스템 전체
    -   vmstat : 메모리 사용량 통계를 보고한다.
    -   netstat : 네트워크 인터페이스에 대한 통계를 보고한다.
    -   iostat : 디스크의 I/O 사용량을 보고한다.

Linux 시스템의 카운터 기반 도구 대부분은 /proc 파일 시스템에서 통계를 읽는다. 커널 메모리에만 존재하는 의사 파일 시스템이며 주로 다양한 프로세스 별 통계와 커널 통계를 질의하는데 사용된다.

/proc 파일 시스템은 계층 디렉터리 구조로 구성되며 프로세스가 하위 디렉토리로 표시된다. ex. /proc/2155 ID가 2155인 프로세스에 대한 항목별 통계 제공

Windows는 작언관리자를 제공

## 2.10.3 추적

카운터 기반 도구는 커널에서 유지 관리하는 특정 통계의 현재 값에 대해 간단히 문의하는 반면

추적도구는 시스템 콜과 관련된 단계와 같은 특정 이벤트에 대한 데이터를 수집한다.

-   프로세스별
    -   strace : 프로세스에 의해 호출된 시스템 콜을 추적한다.
    -   gdb : 소스 레벨 디버거
-   시스템 전체
    -   perf : 리눅스 성능 도구 모음
    -   tcpdump : 네트워크 패킷을 수집한다.

## 2.10.4 BCC

사용자 수준과 커널 코드의 상호작용을 디버깅하는 것은 양쪽의 코드를 이해하고 상호 작용을 계측할 수 있는 도구 집합 없이는 불가능하다.

도구 집합이 유용하려면 디버깅을 염두에 두지 않고 작성된 부분을 포함한 시스템의 어느 부분도 디버깅할 수 있어야 하며 그 작업을 시스템의 안정성을 해치지 않고 할 수 있어야 한다.

이 도구 집합은 또한 성능에 미치는 영향을 최소로 해야 한다. 이상적으로는 사용하지 않을 경우에는 성능에 전혀 영향을 주지 않고 사용 중일 때에는 그에 비례하게 성능에 영향을 주어야 한다.

`BCC 도구집합`은 이러한 요구 조건을 만족시키면서 동적이고, 안전하며 낮은 영향력을 미치는 디버깅 환경을 제공한다.

`BCC (BPF Compiler Collection)`는 Linux 시스템을 위한 추적기능을 제공하는 풍부한 툴킷이다.

BCC v패키지는 실행 중인 Linux 커널에서 여러 활동영역을 관찰하는 여러 기존 도구를 제공한다.

```shell
-- BCC disksnoop  도구의  디스크 I/O작업 추적 명령어
./disksnoop.py
```

I/O작업이 발생한 시간, I/O가 읽기 또는 쓰기 작업인지 여부 및 I/O에 관련된 바이트 수를 알려준다. 마지막 열은 지속 시간(지연시간 또는 LAT로 표시)을 I/O의 밀리초 단위로 반영한다.

BCC가 제공하는 많은 도구는 MySql, Java, Python프로그램과 같은 특정 응용프로그램에 사용할 수 있다.

특정 프로세스의 활동을 관찰하기 위한 probe를 배치할 수도 있다.

```shell
-- 식별자가 1225인 프로세스가 수행한 open()시스템 콜만 추적
./opensoop -p 1225
```

BCC를 강력하게 만드는 것은 시스템에 해를 끼치지 않고 중요한 응용 프로그램을 실행하는 실제 프로덕션 시스템에서 해당 도구를 사용할 수 있다는 것

이는 병목현상이나 보안 악용 가능성을 식별하기 위해 시스템 성능을 관찰해야 하는 시스템 관리자에게 유용하다.

Spring Actuator는 "내가 만든 앱의 건강 상태를 앱 내부에서 보는 도구"
BCC/eBPF는 "운영체제 입장에서 내 앱이 시스템에 미치는 영향까지 추적하는 도구"
