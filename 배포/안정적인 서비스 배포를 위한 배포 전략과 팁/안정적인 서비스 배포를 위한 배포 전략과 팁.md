# 안정적인 서비스 배포를 위한 배포 전략과 팁

서비스 장애가 발생했을 때 그 원인을 주로 폭발적으로 늘어난 트래픽이 장애의 원인이라고 생각하지만

주로 잘못된 코드(또는 설정)가 배포되는 상황

## 상황에 맞는 배포 전략들

### 롤링 배포

롤링 배포 : 전체 시스템을 중단하지 않고 새로운 버전을 점진적으로 배포하는 방법 서비스 중단없이 업데이트 가능 (즉 무중단 배포)

하나의 서버에 배포후 다음 서버로 넘어갈때 배포 서버가 정상적으로 동작하지 않으면 롤백하는 과정을 거쳐야 한다. (CD테스트)

장점

-   전체 시스템의 처리 능력을 유지하면서 배포 (가용성 유지)
-   사용자에게 불편이 가지 않음
-   점진적 적용을 통해 리스크를 최소화할 수 있다.

단점

-   모든 서버를 업데이트하는데 속도가 느리다 (하나씩 하니까)
-   동시에 서로 다른 버전으로 서비스가 될 수 있다. (DB스키마 변경이나 API간 호환문제 발생가능 )

### 블루 그린 배포

기존 버전의 서비스를 유지해 둔 상태에서 새로운 버전을 별도의 환경에 배포를 하고 즉시 한방에 전환을 하는것 (역시 무중단) 전환은 보통 로드밸런싱 설정을 통해 변경

각각의 환경을 블루/그린으로 순서를 번갈아 가며 명칭

새로운 환경으로 변경했다 하더라고 기존환경 어느정도 유지 (롤백 대비)

장점

-   즉각적인 전환과 롤백이 가능
-   서비스 중단 시간 최소화
-   새로운 버전을 실제 환경과 동일한 환경에서 테스트를 해볼 수 있다.

단점

-   리소스 사용량이 많다. 당장 서버 비용 2배
-   복잡한 설정과 관리가 필요하다.

### 롤링 배포 블루그린 배포 차이

|             | 롤링 배포              | 블루그린 배포                     |
| ----------- | ---------------------- | --------------------------------- |
| 배포방식    | 하나씩 순차적으로 진행 | 동일한 서버군 생성 후 한방에 전환 |
| 배포속도    | 느림                   | 빠름                              |
| 문제 발생시 | 배포된 서버만 영향     | 모든 사용자가 영향, 롤백은 간단   |
| 비용        | 추가적인 서버 필요 x   | 일시적으로 두배의 리소스 필요     |
| 복잡성      | 상대적으로 단순        | 상대적으로 복잡                   |

### 카나리 배포, A/B 테스트 배포

-   카나리 배포

    -   새버전의 소프트웨어를 전체 사용자에게 적용전 일부 사용자에게 먼저 배포하여 반응을 테스트하는 방식
    -   이상이 없다면 점진적으로 배포하여 리스트 최소화
    -   일부 서버 또는 일부 사용자 둘다 카나리 배포라고 명칭
        -   일부 사용자는 지속해서 새버전의 서버로만 포워딩되도록 처리
    -   장점
        -   리스크 최소화
    -   단점
        -   설정하고 관리가 복잡
        -   사용자 경험일 일관적이지 않다

-   A/B 테스트 배포

    -   새버전의 배포가 목적이 아닌 각기 다른 환경에서 사용자의 영향 분석
    -   보통 배포를 빼서 A/B 테스트라고만 함

    -   장/단점 카나리 배포와 비슷

### 배포 타이밍

-   사용자가 적은 시간대
-   금요일 저녁은 피한다
-   배포후 모니터링을 시간이 확보되어야 한다.

### 성능이 중요한 서비스라면 웜업(Warm Up)은 필수

-   서버 배포후 일정 자원들의 초기화 시간이 필요 (또는 캐싱되는데 필요한 시간 필요 캐시미스 방지)
-   커넥션 풀의 커넥션 숫자 자체가 DB쪽 연결 가능 숫자보다 많게 되면 커넥션 생성 불가
-   외부서비스와 연동되있을 시 외부 서비스또한 과부하 될 수 있음

-   점진적인 웜업을 시작하거나 서킷 브레이커같은걸 도입하는 것도 방법

-   실제로 받는 트래픽과 유사한 형태와 양으로 점진적 부하를 늘려나가는 웜업 스크립트 작성

-   JVM 핫스팟 존 최적화 (JIT컴파일러가)

## 슬랙으로 배포 관련 알람 받아보기

### 알람이 필요한 이유

실시간 모니터링의 중요성

-   배포는 서비스의 안정성과 직결되는 중요한 과정
-   문제 발생시 빠르게 대응하기 위해 이러한 메신저 알람이 필요

### 슬랙 봇 만들기

### 슬랙 봇 메시지를 보내도록 Jenkins 스크립트 작성하기

### 알람에 어떤 메시지가 포함되는게 좋을까?

## 개발 환경 운영 환경

### 개발환경과 운영환경을 나누는 방법

### 개발 환경에서 테스트하고 운영환경으로 배포하기

### 더 세분화된 개발 환경들

-   로컬 환경
-   개발 환경
-   CBT(Closed Beta Testing)환경
    -   개발 환경에서 코드는 개발이 완료된 상태에서 운영환경에 있는 데이터로 테스트 하는 환경
-   스테이징 환경
    -   운영 환경과 서버 리소스등 동일하게 환경을 구성하고 성능 테스트같은 비 기능적인 요구사항을 테스트
-   운영환경
